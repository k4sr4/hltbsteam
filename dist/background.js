(()=>{"use strict";var e,t,a={},s={};function r(e){var t=s[e];if(void 0!==t)return t.exports;var i=s[e]={exports:{}};return a[e](i,i.exports,r),i.exports}r.m=a,r.d=(e,t)=>{for(var a in t)r.o(t,a)&&!r.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce((t,a)=>(r.f[a](e,t),t),[])),r.u=e=>e+".js",r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="hltb-steam-extension:",r.l=(a,s,i,n)=>{if(e[a])e[a].push(s);else{var l,o;if(void 0!==i)for(var c=document.getElementsByTagName("script"),h=0;h<c.length;h++){var m=c[h];if(m.getAttribute("src")==a||m.getAttribute("data-webpack")==t+i){l=m;break}}l||(o=!0,(l=document.createElement("script")).charset="utf-8",l.timeout=120,r.nc&&l.setAttribute("nonce",r.nc),l.setAttribute("data-webpack",t+i),l.src=a),e[a]=[s];var u=(t,s)=>{l.onerror=l.onload=null,clearTimeout(d);var r=e[a];if(delete e[a],l.parentNode&&l.parentNode.removeChild(l),r&&r.forEach(e=>e(s)),t)return t(s)},d=setTimeout(u.bind(null,void 0,{type:"timeout",target:l}),12e4);l.onerror=u.bind(null,l.onerror),l.onload=u.bind(null,l.onload),o&&document.head.appendChild(l)}},(()=>{var e;r.g.importScripts&&(e=r.g.location+"");var t=r.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var a=t.getElementsByTagName("script");if(a.length)for(var s=a.length-1;s>-1&&(!e||!/^http(s?):/.test(e));)e=a[s--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=e})(),(()=>{var e={471:0};r.f.j=(t,a)=>{var s=r.o(e,t)?e[t]:void 0;if(0!==s)if(s)a.push(s[2]);else{var i=new Promise((a,r)=>s=e[t]=[a,r]);a.push(s[2]=i);var n=r.p+r.u(t),l=new Error;r.l(n,a=>{if(r.o(e,t)&&(0!==(s=e[t])&&(e[t]=void 0),s)){var i=a&&("load"===a.type?"missing":a.type),n=a&&a.target&&a.target.src;l.message="Loading chunk "+t+" failed.\n("+i+": "+n+")",l.name="ChunkLoadError",l.type=i,l.request=n,s[1](l)}},"chunk-"+t,t)}};var t=(t,a)=>{var s,i,[n,l,o]=a,c=0;if(n.some(t=>0!==e[t])){for(s in l)r.o(l,s)&&(r.m[s]=l[s]);o&&o(r)}for(t&&t(a);c<n.length;c++)i=n[c],r.o(e,i)&&e[i]&&e[i][0](),e[i]=0},a=self.webpackChunkhltb_steam_extension=self.webpackChunkhltb_steam_extension||[];a.forEach(t.bind(null,0)),a.push=t.bind(null,a.push.bind(a))})();class i extends Error{constructor(e=60){super(`Rate limit exceeded. Retry after ${e} seconds`),this.name="RateLimitError",this.retryAfter=e,this.resetTime=new Date(Date.now()+1e3*e)}}class n extends Error{constructor(e,t,a){super(e),this.name="NetworkError",this.statusCode=t,this.originalError=a}}class l{constructor(e=3,t=1e3,a=3e4){this.retryCount=new Map,this.lastAttempt=new Map,this.maxRetries=e,this.baseDelay=t,this.maxDelay=a}async executeWithRetry(e,t,a){const s=this.retryCount.get(e)||0;try{const a=await t();return this.retryCount.delete(e),this.lastAttempt.delete(e),a}catch(r){if(s>=this.maxRetries)throw this.retryCount.delete(e),this.lastAttempt.delete(e),r;if(!(a?a(r):this.isDefaultRetriableError(r)))throw r;const i=this.calculateDelay(s);return this.retryCount.set(e,s+1),this.lastAttempt.set(e,Date.now()),console.log(`[RetryManager] Attempt ${s+1}/${this.maxRetries} for ${e}. Waiting ${i}ms`),await this.delay(i),this.executeWithRetry(e,t,a)}}calculateDelay(e){const t=Math.min(this.baseDelay*Math.pow(2,e),this.maxDelay),a=.25*Math.random()*t;return Math.floor(t+a)}delay(e){return new Promise(t=>setTimeout(t,e))}isDefaultRetriableError(e){if(e instanceof n){const t=e.statusCode;return!t||t>=500||429===t||0===t}return e instanceof i||"NetworkError"===e.name||"FetchError"===e.name||"AbortError"===e.name}reset(e){e?(this.retryCount.delete(e),this.lastAttempt.delete(e)):(this.retryCount.clear(),this.lastAttempt.clear())}}class o{constructor(e={}){this.options=e,this.API_ENDPOINT="https://howlongtobeat.com/api/search",this.rateLimitReset=null,this.retryManager=new l(e.maxRetries||3,e.baseDelay||1e3,e.maxDelay||3e4)}async searchGames(e){if(this.rateLimitReset&&this.rateLimitReset>new Date){const e=Math.ceil((this.rateLimitReset.getTime()-Date.now())/1e3);throw new i(e)}const t=this.buildSearchPayload(e);return this.retryManager.executeWithRetry(`search:${e}`,async()=>{const e=await this.makeRequest(t);return this.parseResponse(e)})}async getGameData(e){const t=await this.searchGames(e);return t&&0!==t.length?await this.findBestMatch(e,t):null}buildSearchPayload(e){return{searchType:"games",searchTerms:e.split(" ").filter(e=>e.length>0),searchPage:1,size:20,searchOptions:{games:{userId:0,platform:"",sortCategory:"popular",rangeCategory:"main",rangeTime:{min:0,max:0},gameplay:{perspective:"",flow:"",genre:""},modifier:""},users:{sortCategory:"postcount"},filter:"",sort:0,randomizer:0}}}async makeRequest(e){const t=new AbortController,a=this.options.timeout||3e4,s=setTimeout(()=>t.abort(),a);try{const a=await fetch(this.API_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","Accept-Language":"en-US,en;q=0.9",Referer:"https://howlongtobeat.com",Origin:"https://howlongtobeat.com","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36","Cache-Control":"no-cache",Pragma:"no-cache"},body:JSON.stringify(e),signal:t.signal});if(clearTimeout(s),429===a.status){const e=this.parseRetryAfter(a.headers);throw this.rateLimitReset=new Date(Date.now()+1e3*e),new i(e)}if(!a.ok)throw new n(`HTTP ${a.status}: ${a.statusText}`,a.status);try{return await a.json()}catch(e){throw new n("Failed to parse response JSON",a.status,e)}}catch(e){if(clearTimeout(s),e instanceof Error&&"AbortError"===e.name)throw new n("Request timeout",void 0,e);if(e instanceof i||e instanceof n)throw e;throw new n("Network request failed",void 0,e)}}parseRetryAfter(e){const t=e.get("Retry-After");if(!t)return 60;const a=parseInt(t,10);if(!isNaN(a))return a;const s=new Date(t);return isNaN(s.getTime())?60:Math.max(0,Math.ceil((s.getTime()-Date.now())/1e3))}parseResponse(e){return e.data&&Array.isArray(e.data)?e.data.map(e=>this.parseGameData(e)):[]}parseGameData(e){return{mainStory:this.parseTimeValue(e.comp_main),mainExtra:this.parseTimeValue(e.comp_plus),completionist:this.parseTimeValue(e.comp_100),allStyles:this.parseTimeValue(e.comp_all),gameId:e.game_id,gameName:e.game_name,imageUrl:e.game_image?`https://howlongtobeat.com/games/${e.game_image}`:void 0,playerCounts:{main:e.comp_main_count||0,extra:e.comp_plus_count||0,completionist:e.comp_100_count||0,all:e.comp_all_count||0}}}parseTimeValue(e){if(null==e||0===e)return null;let t;if("string"==typeof e){const a=e.toString().replace(/[^\d.½¼¾]/g,""),s={"½":.5,"¼":.25,"¾":.75};let r=a;if(Object.keys(s).forEach(e=>{r=r.replace(e,s[e].toString())}),t=parseFloat(r),isNaN(t))return null}else t=Number(e);const a=t/60;return a<10?Math.round(10*a)/10:Math.round(a)}async findBestMatch(e,t){if(0===t.length)return null;const{titleMatcher:a}=await r.e(147).then(r.bind(r,147)),s=t.map(e=>({gameId:e.gameId,gameName:e.gameName,gameImage:e.gameImage,mainStory:e.mainStory,mainExtra:e.mainExtra,completionist:e.completionist,allStyles:e.allStyles})),i=await a.findBestMatch(e,s);return i&&i.match?i.skip?(console.log(`[HLTBApiClient] Skipping "${e}": ${i.reason}`),null):(console.log(`[HLTBApiClient] Matched "${e}" -> "${i.match.gameName}" (${(100*i.confidence).toFixed(1)}% via ${i.method})`),t.find(e=>e.gameId===i.match.gameId)||null):(console.log(`[HLTBApiClient] No match found for "${e}"`),null)}async batchFetch(e){const t=new Map,a=[];for(let t=0;t<e.length;t+=5)a.push(e.slice(t,t+5));for(const e of a){const s=e.map(async e=>{try{const a=await this.getGameData(e.title);t.set(e.id,a)}catch(a){if(console.error(`[HLTBApiClient] Failed to fetch data for ${e.title}:`,a),t.set(e.id,null),a instanceof i)throw a}});try{await Promise.all(s)}catch(e){if(e instanceof i){console.warn("[HLTBApiClient] Rate limited during batch fetch");break}throw e}a.indexOf(e)<a.length-1&&await this.delay(500)}return t}delay(e){return new Promise(t=>setTimeout(t,e))}clearRateLimit(){this.rateLimitReset=null}resetRetries(e){this.retryManager.reset(e)}}new o({maxRetries:3,baseDelay:1e3,maxDelay:3e4,timeout:3e4});class c extends Error{constructor(e,t,a){super(e),this.name="ScrapingError",this.statusCode=t,this.url=a}}const h=new class{constructor(){this.BASE_URL="https://howlongtobeat.com",this.SEARCH_URL="https://howlongtobeat.com/search_results",this.USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",this.SELECTORS={searchResults:".search_list_details",gameCard:".search_list_details_block",gameName:".search_list_details_block h3 a",gameNameAlt:".search_list_details_block .search_list_details_block_title",gameImage:"img.search_list_image",gameLink:"h3 a",timeContainer:".search_list_tidbit",timeLabel:".search_list_tidbit_short",timeValue:".search_list_tidbit_long",noResults:".search_list_no_results"}}async scrapeGameData(e){console.log("[HLTB Scraper] Scraping data for:",e);try{const t=await this.fetchSearchResults(e);if(!t)throw new c("Failed to fetch HTML content");const a=this.parseSearchResults(t,e);return console.log(`[HLTB Scraper] Found ${a.games.length} games for "${e}"`),a}catch(e){return console.error("[HLTB Scraper] Error:",e),null}}async fetchSearchResults(e){const t=`${this.SEARCH_URL}?page=1&length=20&sort=name&search=${encodeURIComponent(e)}`;try{const e=await fetch(t,{method:"GET",headers:{"User-Agent":this.USER_AGENT,Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8","Accept-Language":"en-US,en;q=0.5","Accept-Encoding":"gzip, deflate, br",Connection:"keep-alive","Upgrade-Insecure-Requests":"1","Sec-Fetch-Dest":"document","Sec-Fetch-Mode":"navigate","Sec-Fetch-Site":"none","Cache-Control":"max-age=0",Referer:"https://howlongtobeat.com/"}});if(!e.ok)throw new c(`HTTP ${e.status}: ${e.statusText}`,e.status,t);const a=await e.text();if(!a||a.length<100)throw new c("Received empty or invalid HTML response");return a}catch(e){if(e instanceof c)throw e;throw new c(`Network error: ${e instanceof Error?e.message:"Unknown error"}`,void 0,t)}}parseSearchResults(e,t){const a=(new DOMParser).parseFromString(e,"text/html");if(a.querySelector(this.SELECTORS.noResults))return console.log("[HLTB Scraper] No results found"),{games:[],totalResults:0,searchTerm:t,timestamp:Date.now()};const s=a.querySelectorAll(this.SELECTORS.gameCard);console.log(`[HLTB Scraper] Found ${s.length} game cards`);const r=[];return s.forEach((e,t)=>{try{const t=this.parseGameCard(e);t&&r.push(t)}catch(e){console.warn(`[HLTB Scraper] Failed to parse game card ${t}:`,e)}}),{games:r,totalResults:r.length,searchTerm:t,timestamp:Date.now()}}parseGameCard(e){try{const t=e.querySelector(this.SELECTORS.gameName)||e.querySelector(this.SELECTORS.gameNameAlt);if(!t)return console.warn("[HLTB Scraper] No game name found in card"),null;const a=this.cleanText(t.textContent||"");if(!a)return console.warn("[HLTB Scraper] Empty game name"),null;const s=e.querySelector(this.SELECTORS.gameLink);let r=null,i=null;s&&s.href&&(i=this.normalizeUrl(s.href),r=this.extractGameIdFromUrl(i));const n=e.querySelector(this.SELECTORS.gameImage);let l=null;return n&&n.src&&(l=this.normalizeUrl(n.src)),{id:r,name:a,image:l,url:i,...this.parseCompletionTimes(e)}}catch(e){return console.error("[HLTB Scraper] Error parsing game card:",e),null}}parseCompletionTimes(e){const t={mainStory:null,mainExtra:null,completionist:null,allStyles:null};return e.querySelectorAll(this.SELECTORS.timeContainer).forEach(e=>{try{const a=e.querySelector(this.SELECTORS.timeLabel),s=e.querySelector(this.SELECTORS.timeValue);if(!a||!s)return;const r=this.cleanText(a.textContent||"").toLowerCase(),i=this.cleanText(s.textContent||"");if(!r||!i)return;const n=this.parseTimeString(i);r.includes("main story")||r.includes("main")?t.mainStory=n:r.includes("main + extra")||r.includes("main+extra")?t.mainExtra=n:r.includes("completionist")||r.includes("100%")?t.completionist=n:(r.includes("all styles")||r.includes("average"))&&(t.allStyles=n)}catch(e){console.warn("[HLTB Scraper] Error parsing time container:",e)}}),t}parseTimeString(e){if(!e||"--"===e||"-"===e||"n/a"===e.toLowerCase())return null;const t=e.toLowerCase().trim().replace(/hours?/g,"").replace(/hrs?/g,"").replace(/h/g,"").replace(/mins?/g,"").replace(/m/g,"").trim();if(!t)return null;try{let e=t.replace(/½/g,".5").replace(/¼/g,".25").replace(/¾/g,".75").replace(/⅓/g,".33").replace(/⅔/g,".67");const a=e.match(/(\d+(?:\.\d+)?)\s*[-–—]\s*(\d+(?:\.\d+)?)/);if(a){const e=parseFloat(a[1]),t=parseFloat(a[2]);if(!isNaN(e)&&!isNaN(t))return Math.round((e+t)/2)}const s=e.match(/(\d+(?:\.\d+)?)/);if(s){const e=parseFloat(s[1]);if(!isNaN(e)&&e>0)return Math.round(e)}return null}catch(t){return console.warn("[HLTB Scraper] Error parsing time string:",e,t),null}}extractGameIdFromUrl(e){try{const t=e.match(/[?&]id=(\d+)/);return t?t[1]:null}catch(t){return console.warn("[HLTB Scraper] Error extracting game ID from URL:",e,t),null}}normalizeUrl(e){return e?e.startsWith("//")?`https:${e}`:e.startsWith("/")?`${this.BASE_URL}${e}`:e:""}cleanText(e){return e?e.replace(/\s+/g," ").replace(/\n+/g," ").trim().substring(0,200):""}async findBestMatch(e,t){if(!t||0===t.length)return null;const{titleMatcher:a}=await r.e(147).then(r.bind(r,147)),s=t.map(e=>({gameId:e.id||"",gameName:e.name,mainStory:e.mainStory,mainExtra:e.mainExtra,completionist:e.completionist,allStyles:e.allStyles})),i=await a.findBestMatch(e,s);return i&&i.match?i.skip?(console.log(`[HLTB Scraper] Skipping "${e}": ${i.reason}`),null):(console.log(`[HLTB Scraper] Matched "${e}" -> "${i.match.gameName}" (${(100*i.confidence).toFixed(1)}% via ${i.method})`),t.find(e=>e.name===i.match.gameName)||null):(console.log(`[HLTB Scraper] No match found for "${e}"`),null)}calculateSimilarity(e,t){if(e===t)return 1;const a=e.length>t.length?e:t,s=e.length>t.length?t:e;if(0===a.length)return 0;const r=this.levenshteinDistance(a,s);return(a.length-r)/a.length}levenshteinDistance(e,t){const a=[];for(let e=0;e<=t.length;e++)a[e]=[e];for(let t=0;t<=e.length;t++)a[0][t]=t;for(let s=1;s<=t.length;s++)for(let r=1;r<=e.length;r++)t.charAt(s-1)===e.charAt(r-1)?a[s][r]=a[s-1][r-1]:a[s][r]=Math.min(a[s-1][r-1]+1,a[s][r-1]+1,a[s-1][r]+1);return a[t.length][e.length]}validateGameData(e){return!!(e&&"string"==typeof e.name&&e.name.length>0&&e.name.length<=200)}async getScraperStatus(){const e=Date.now();try{const t=await fetch(`${this.BASE_URL}/search_results?search=portal`,{method:"HEAD",headers:{"User-Agent":this.USER_AGENT}}),a=Date.now()-e;return{isHealthy:t.ok,lastCheck:Date.now(),responseTime:a,error:t.ok?null:`HTTP ${t.status}`}}catch(e){return{isHealthy:!1,lastCheck:Date.now(),responseTime:null,error:e instanceof Error?e.message:"Unknown error"}}}},m=new class{constructor(){this.COMMUNITY_DB_URL="https://raw.githubusercontent.com/username/hltb-db/main/games.json",this.localDatabase=new Map,this.aliasMap=new Map,this.initializeLocalDatabase(),this.loadCommunityDatabase()}initializeLocalDatabase(){const e=[{title:"Portal",aliases:["portal 1"],data:{mainStory:3,mainExtra:4,completionist:5,allStyles:4},confidence:"high",lastUpdated:"2024-01"},{title:"Portal 2",aliases:["portal two","portal ii"],data:{mainStory:8,mainExtra:10,completionist:14,allStyles:9},confidence:"high",lastUpdated:"2024-01"},{title:"Half-Life",aliases:["halflife","half life"],data:{mainStory:12,mainExtra:13,completionist:15,allStyles:12},confidence:"high",lastUpdated:"2024-01"},{title:"Half-Life 2",aliases:["halflife 2","half life 2","hl2"],data:{mainStory:13,mainExtra:15,completionist:18,allStyles:13},confidence:"high",lastUpdated:"2024-01"},{title:"Half-Life: Alyx",aliases:["half life alyx","hl alyx","alyx"],data:{mainStory:12,mainExtra:13,completionist:18,allStyles:12},confidence:"high",lastUpdated:"2024-01"},{title:"Team Fortress 2",aliases:["tf2","team fortress two"],data:{mainStory:null,mainExtra:null,completionist:null,allStyles:null},confidence:"high"},{title:"Counter-Strike 2",aliases:["cs2","cs 2","counterstrike 2"],data:{mainStory:null,mainExtra:null,completionist:null,allStyles:null},confidence:"high"},{title:"Counter-Strike: Global Offensive",aliases:["csgo","cs go","cs:go"],data:{mainStory:null,mainExtra:null,completionist:null,allStyles:null},confidence:"high"},{title:"Dota 2",aliases:["dota two"],data:{mainStory:null,mainExtra:null,completionist:null,allStyles:null},confidence:"high"},{title:"Hades",aliases:["hades 1"],data:{mainStory:22,mainExtra:45,completionist:95,allStyles:55},confidence:"high",lastUpdated:"2024-01"},{title:"Hades II",aliases:["hades 2","hades two"],data:{mainStory:15,mainExtra:25,completionist:50,allStyles:30},confidence:"medium",lastUpdated:"2024-09"},{title:"Hollow Knight",aliases:[],data:{mainStory:27,mainExtra:40,completionist:63,allStyles:42},confidence:"high",lastUpdated:"2024-01"},{title:"Celeste",aliases:[],data:{mainStory:8,mainExtra:12,completionist:37,allStyles:28},confidence:"high",lastUpdated:"2024-01"},{title:"Stardew Valley",aliases:[],data:{mainStory:53,mainExtra:95,completionist:156,allStyles:96},confidence:"high",lastUpdated:"2024-01"},{title:"Terraria",aliases:[],data:{mainStory:50,mainExtra:104,completionist:215,allStyles:115},confidence:"high",lastUpdated:"2024-01"},{title:"Elden Ring",aliases:[],data:{mainStory:60,mainExtra:100,completionist:130,allStyles:96},confidence:"high",lastUpdated:"2024-01"},{title:"The Witcher 3: Wild Hunt",aliases:["witcher 3","the witcher three"],data:{mainStory:50,mainExtra:100,completionist:170,allStyles:101},confidence:"high",lastUpdated:"2024-01"},{title:"Red Dead Redemption 2",aliases:["rdr2","red dead 2"],data:{mainStory:50,mainExtra:80,completionist:180,allStyles:80},confidence:"high",lastUpdated:"2024-01"},{title:"Grand Theft Auto V",aliases:["gta 5","gta v","gtav"],data:{mainStory:32,mainExtra:48,completionist:83,allStyles:52},confidence:"high",lastUpdated:"2024-01"},{title:"Cyberpunk 2077",aliases:["cyberpunk","cp2077"],data:{mainStory:25,mainExtra:60,completionist:105,allStyles:61},confidence:"high",lastUpdated:"2024-01"},{title:"Baldur's Gate 3",aliases:["bg3","baldurs gate 3"],data:{mainStory:75,mainExtra:100,completionist:200,allStyles:107},confidence:"high",lastUpdated:"2024-01"},{title:"Dark Souls",aliases:["dark souls 1","ds1"],data:{mainStory:42,mainExtra:60,completionist:105,allStyles:66},confidence:"high",lastUpdated:"2024-01"},{title:"Dark Souls II",aliases:["dark souls 2","ds2"],data:{mainStory:44,mainExtra:70,completionist:120,allStyles:78},confidence:"high",lastUpdated:"2024-01"},{title:"Dark Souls III",aliases:["dark souls 3","ds3"],data:{mainStory:32,mainExtra:48,completionist:100,allStyles:59},confidence:"high",lastUpdated:"2024-01"},{title:"Sekiro: Shadows Die Twice",aliases:["sekiro"],data:{mainStory:30,mainExtra:40,completionist:70,allStyles:41},confidence:"high",lastUpdated:"2024-01"},{title:"Civilization VI",aliases:["civ 6","civ vi","civilization 6"],data:{mainStory:22,mainExtra:40,completionist:220,allStyles:81},confidence:"high",lastUpdated:"2024-01"},{title:"Total War: WARHAMMER III",aliases:["total warhammer 3","tww3"],data:{mainStory:32,mainExtra:125,completionist:280,allStyles:180},confidence:"medium",lastUpdated:"2024-01"},{title:"The Binding of Isaac: Rebirth",aliases:["binding of isaac rebirth","tboi rebirth"],data:{mainStory:13,mainExtra:50,completionist:270,allStyles:140},confidence:"high",lastUpdated:"2024-01"},{title:"Risk of Rain 2",aliases:["ror2"],data:{mainStory:10,mainExtra:30,completionist:120,allStyles:59},confidence:"high",lastUpdated:"2024-01"},{title:"Dead Cells",aliases:[],data:{mainStory:14,mainExtra:30,completionist:83,allStyles:46},confidence:"high",lastUpdated:"2024-01"}];for(const t of e){const e=this.normalizeTitle(t.title);if(this.localDatabase.set(e,t),t.aliases)for(const a of t.aliases)this.aliasMap.set(this.normalizeTitle(a),e)}console.log(`[HLTB Fallback] Initialized with ${this.localDatabase.size} games`)}async loadCommunityDatabase(){try{const e=await fetch(this.COMMUNITY_DB_URL,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(5e3)});if(e.ok){const t=await e.json();this.populateCommunityData(t),console.log("[HLTB Fallback] Community database loaded")}}catch(e){console.log("[HLTB Fallback] Community database not available, using local data only")}}populateCommunityData(e){if(!Array.isArray(e))return;let t=0;for(const a of e){if(!a.title||!a.data)continue;const e=this.normalizeTitle(a.title),s=this.localDatabase.get(e);s&&"high"===s.confidence||(this.localDatabase.set(e,{title:a.title,aliases:a.aliases||[],data:a.data,confidence:"medium",lastUpdated:a.lastUpdated}),t++)}console.log(`[HLTB Fallback] Added ${t} games from community database`)}async searchFallback(e){const t=this.normalizeTitle(e);if(this.localDatabase.has(t))return console.log(`[HLTB Fallback] Direct match found for: ${e}`),this.localDatabase.get(t).data;if(this.aliasMap.has(t)){const a=this.aliasMap.get(t);return console.log(`[HLTB Fallback] Alias match found for: ${e}`),this.localDatabase.get(a).data}const a=this.findFuzzyMatch(t);if(a)return console.log(`[HLTB Fallback] Fuzzy match found for: ${e}`),a;const s=this.findPartialMatch(t);return s?(console.log(`[HLTB Fallback] Partial match found for: ${e}`),s):(console.log(`[HLTB Fallback] No match found for: ${e}`),null)}findFuzzyMatch(e){const t=e.split(/\s+/);let a=null,s=0;for(const[e,r]of this.localDatabase.entries()){const i=e.split(/\s+/);let n=0;for(const e of t)i.some(t=>t.includes(e)||e.includes(t))&&n++;const l=n/Math.max(t.length,i.length);l>s&&l>=.5&&(s=l,a=r)}return a?a.data:null}findPartialMatch(e){for(const[t,a]of this.localDatabase.entries())if((t.includes(e)||e.includes(t))&&(!e.includes(t)||t.length>.5*e.length))return a.data;return null}normalizeTitle(e){return e.toLowerCase().replace(/[^a-z0-9\s]/g,"").replace(/\s+/g," ").trim()}getAvailableGames(){return Array.from(this.localDatabase.values()).map(e=>e.title)}getStats(){const e=Array.from(this.localDatabase.values()).filter(e=>"high"===e.confidence).length,t=Array.from(this.localDatabase.values()).filter(e=>"medium"===e.confidence).length,a=Array.from(this.localDatabase.values()).filter(e=>"low"===e.confidence).length;return{totalGames:this.localDatabase.size,totalAliases:this.aliasMap.size,highConfidence:e,mediumConfidence:t,lowConfidence:a}}};class u{constructor(){this.CACHE_KEY="hltb_cache",this.cache=new Map,this.cacheDuration=6048e5,this.loadCache()}async loadCache(){const e=await chrome.storage.local.get(this.CACHE_KEY);e[this.CACHE_KEY]&&(this.cache=new Map(Object.entries(e[this.CACHE_KEY])),this.cleanExpired())}async saveCache(){await chrome.storage.local.set({[this.CACHE_KEY]:Object.fromEntries(this.cache)})}async get(e){const t=this.cache.get(e);return t?Date.now()-t.timestamp>this.cacheDuration?(this.cache.delete(e),await this.saveCache(),null):(t.hits++,await this.saveCache(),t.data):null}async set(e,t){this.cache.set(e,{data:t,timestamp:Date.now(),hits:0}),this.cache.size>1e3&&this.evictLRU(),await this.saveCache()}cleanExpired(){const e=Date.now();for(const[t,a]of this.cache.entries())e-a.timestamp>this.cacheDuration&&this.cache.delete(t)}evictLRU(){let e="",t=1/0;for(const[a,s]of this.cache.entries()){const r=s.hits+(Date.now()-s.timestamp)/1e6;r<t&&(t=r,e=a)}e&&this.cache.delete(e)}async getStats(){const e=Array.from(this.cache.values());return 0===e.length?{size:0,hits:0,oldestEntry:null,totalSize:0}:{size:this.cache.size,hits:e.reduce((e,t)=>e+t.hits,0),oldestEntry:Math.min(...e.map(e=>e.timestamp)),totalSize:JSON.stringify(Object.fromEntries(this.cache)).length}}async clear(){this.cache.clear(),await chrome.storage.local.remove(this.CACHE_KEY)}}class d{constructor(e,t){this.maxTokens=e,this.windowMs=t,this.tokens=e,this.lastRefill=Date.now()}async wait(){if(this.refill(),this.tokens>0)return void this.tokens--;const e=this.windowMs-(Date.now()-this.lastRefill);await new Promise(t=>setTimeout(t,e)),this.refill(),this.tokens--}refill(){const e=Date.now();e-this.lastRefill>=this.windowMs&&(this.tokens=this.maxTokens,this.lastRefill=e)}}class p{constructor(){this.queue=[],this.processing=!1,this.rateLimiter=new d(10,6e4)}async enqueue(e){return new Promise((t,a)=>{this.queue.push(async()=>{try{await this.rateLimiter.wait();const a=await e();t(a)}catch(e){a(e)}}),this.process()})}async process(){if(!this.processing&&0!==this.queue.length){for(this.processing=!0;this.queue.length>0;){const e=this.queue.shift();e&&await e()}this.processing=!1}}async flush(){return Promise.all(this.queue.map(e=>e()))}}const g=new class{constructor(){this.stats={apiAttempts:0,apiSuccesses:0,scraperAttempts:0,scraperSuccesses:0,fallbackAttempts:0,fallbackSuccesses:0,cacheHits:0,totalRequests:0,averageRetrievalTime:0},this.totalRetrievalTime=0,this.apiClient=new o({maxRetries:3,baseDelay:1e3,timeout:1e4}),this.cacheService=new u,this.queueService=new p}async getGameData(e,t,a={}){const s=Date.now();this.stats.totalRequests++,console.log(`[HLTB Integrated] Searching for: ${e}`);try{if(!a.skipCache){const a=await this.tryCache(e,t);if(a)return this.updateRetrievalTime(Date.now()-s),a}return await this.queueService.enqueue(async()=>{let r=null;return!a.skipApi&&(r=await this.tryAPI(e,a),r)||!a.skipScraping&&(r=await this.tryScraping(e,a),r)||!a.skipFallback&&(r=await this.tryFallback(e),r)?(await this.cacheResult(e,t,r),this.updateRetrievalTime(Date.now()-s),r):(console.log(`[HLTB Integrated] No data found for: ${e}`),this.updateRetrievalTime(Date.now()-s),null)})}catch(e){return console.error("[HLTB Integrated] Fatal error:",e),this.updateRetrievalTime(Date.now()-s),null}}async tryCache(e,t){const a=(t||e).replace(/[^a-zA-Z0-9_-]/g,"").substring(0,50),s=await this.cacheService.get(a);return s?(console.log("[HLTB Integrated] Cache hit for:",e),this.stats.cacheHits++,s.source||(s.source="cache"),s.confidence||(s.confidence="medium"),s.retrievalTime||(s.retrievalTime=0),s):null}async tryAPI(e,t){console.log("[HLTB Integrated] Trying API for:",e),this.stats.apiAttempts++;try{const t=await this.apiClient.getGameData(e);if(t)return console.log("[HLTB Integrated] API success for:",e),this.stats.apiSuccesses++,{...t,source:"api",confidence:"high",retrievalTime:Date.now()}}catch(e){e instanceof i?console.warn("[HLTB Integrated] API rate limited, skipping API for future requests"):e instanceof n?console.warn("[HLTB Integrated] API network error:",e.message):console.error("[HLTB Integrated] API error:",e)}return null}async tryScraping(e,t){console.log("[HLTB Integrated] Trying scraper for:",e),this.stats.scraperAttempts++;try{const t=await h.scrapeGameData(e);if(t&&t.games.length>0){const a=await h.findBestMatch(e,t.games);if(a)return console.log("[HLTB Integrated] Scraper success for:",e),this.stats.scraperSuccesses++,{mainStory:a.mainStory,mainExtra:a.mainExtra,completionist:a.completionist,allStyles:a.allStyles,source:"scraper",confidence:"medium",retrievalTime:Date.now()}}}catch(e){console.error("[HLTB Integrated] Scraper error:",e)}return null}async tryFallback(e){console.log("[HLTB Integrated] Trying fallback for:",e),this.stats.fallbackAttempts++;try{const t=await m.searchFallback(e);if(t)return console.log("[HLTB Integrated] Fallback success for:",e),this.stats.fallbackSuccesses++,{...t,source:"fallback",confidence:"low",retrievalTime:Date.now()}}catch(e){console.error("[HLTB Integrated] Fallback error:",e)}return null}async cacheResult(e,t,a){const s=(t||e).replace(/[^a-zA-Z0-9_-]/g,"").substring(0,50);try{await this.cacheService.set(s,a),console.log(`[HLTB Integrated] Cached result for: ${e}`)}catch(e){console.error("[HLTB Integrated] Cache write error:",e)}}updateRetrievalTime(e){this.totalRetrievalTime+=e,this.stats.averageRetrievalTime=Math.round(this.totalRetrievalTime/this.stats.totalRequests)}async batchFetch(e,t={}){const a=new Map;for(let s=0;s<e.length;s+=5){const r=e.slice(s,s+5).map(e=>this.getGameData(e.title,e.appId,t).then(t=>({key:e.appId||e.title,data:t}))),i=await Promise.allSettled(r);for(const e of i)"fulfilled"===e.status?a.set(e.value.key,e.value.data):console.error("[HLTB Integrated] Batch fetch error:",e.reason);s+5<e.length&&await new Promise(e=>setTimeout(e,500))}return a}getStats(){return{...this.stats}}resetStats(){this.stats={apiAttempts:0,apiSuccesses:0,scraperAttempts:0,scraperSuccesses:0,fallbackAttempts:0,fallbackSuccesses:0,cacheHits:0,totalRequests:0,averageRetrievalTime:0},this.totalRetrievalTime=0}async clearCache(){const e=await this.cacheService.clear();return console.log(`[HLTB Integrated] Cleared ${e} cache entries`),e}async getDiagnostics(){const[e,t,a]=await Promise.all([this.cacheService.getStats(),m.getStats(),h.getScraperStatus()]);return{service:{stats:this.getStats(),successRates:{api:this.stats.apiAttempts>0?(this.stats.apiSuccesses/this.stats.apiAttempts*100).toFixed(1)+"%":"N/A",scraper:this.stats.scraperAttempts>0?(this.stats.scraperSuccesses/this.stats.scraperAttempts*100).toFixed(1)+"%":"N/A",fallback:this.stats.fallbackAttempts>0?(this.stats.fallbackSuccesses/this.stats.fallbackAttempts*100).toFixed(1)+"%":"N/A",cacheHitRate:this.stats.totalRequests>0?(this.stats.cacheHits/this.stats.totalRequests*100).toFixed(1)+"%":"N/A"}},cache:e,fallback:t,scraper:a}}async healthCheck(){const e=[];this.stats.apiAttempts>10&&0===this.stats.apiSuccesses&&e.push("API is not responding"),this.stats.scraperAttempts>10&&0===this.stats.scraperSuccesses&&e.push("Scraper is not working"),this.stats.averageRetrievalTime>5e3&&e.push(`Slow average retrieval time: ${this.stats.averageRetrievalTime}ms`);const t=await this.cacheService.getStats();return t.size>1e3&&e.push(`Cache is getting large: ${t.size} entries`),{healthy:0===e.length,issues:e}}},f=new class{constructor(e){this.hltbService=e}async handle(e,t){switch(e.action){case"fetchHLTB":return this.handleFetchHLTB(e);case"clearCache":return this.handleClearCache();case"getCacheStats":return this.handleGetCacheStats();case"batchFetch":return this.handleBatchFetch(e);case"getSettings":return this.handleGetSettings();case"getDiagnostics":return this.handleGetDiagnostics();case"getStats":return this.handleGetStats();case"healthCheck":return this.handleHealthCheck();default:throw new Error(`Unknown action: ${e.action}`)}}async handleFetchHLTB(e){const{gameTitle:t,appId:a}=e;if(!t)return{success:!1,error:"Game title is required"};if(a&&("string"!=typeof a||!/^\d+$/.test(a)))return{success:!1,error:"Invalid app ID"};if("string"!=typeof t||t.length>200)return{success:!1,error:"Invalid game title"};try{return{success:!0,data:await this.hltbService.getGameData(t,a)}}catch(e){return console.error("[HLTB] Fetch error:",e),{success:!1,error:e.message}}}async handleClearCache(){return{success:!0,message:`Cache cleared (${await this.hltbService.clearCache()} entries)`}}async handleGetCacheStats(){return{success:!0,data:(await this.hltbService.getDiagnostics()).cache}}async handleGetSettings(){try{const e=await chrome.storage.local.get(["enabled","cacheEnabled","theme","cacheDurationHours"]);return{success:!0,settings:{enabled:!1!==e.enabled,cacheEnabled:!1!==e.cacheEnabled,theme:e.theme||"auto",cacheDurationHours:e.cacheDurationHours||168}}}catch(e){return console.error("[HLTB] Error getting settings:",e),{success:!1,error:e.message}}}async handleBatchFetch(e){const{games:t}=e;return Array.isArray(t)?{success:!0,data:await this.hltbService.batchFetch(t)}:{success:!1,error:"Games array is required"}}async handleGetDiagnostics(){try{return{success:!0,data:await this.hltbService.getDiagnostics()}}catch(e){return console.error("[HLTB] Error getting diagnostics:",e),{success:!1,error:e.message}}}async handleGetStats(){try{return{success:!0,data:this.hltbService.getStats()}}catch(e){return console.error("[HLTB] Error getting stats:",e),{success:!1,error:e.message}}}async handleHealthCheck(){try{return{success:!0,data:await this.hltbService.healthCheck()}}catch(e){return console.error("[HLTB] Error checking health:",e),{success:!1,error:e.message}}}}(g);chrome.runtime.onInstalled.addListener(async e=>{if(console.log("[HLTB] Extension installed:",e.reason),"install"===e.reason)await chrome.storage.local.set({enabled:!0,cacheEnabled:!0,cacheDurationHours:168,rateLimit:{maxRequests:10,windowMs:6e4}});else if("update"===e.reason){const t=e.previousVersion;console.log("[HLTB] Updated from version:",t)}}),chrome.runtime.onMessage.addListener((e,t,a)=>(console.log("[HLTB] Message received:",e.action),f.handle(e,t).then(a).catch(e=>{console.error("[HLTB] Message handler error:",e),a({success:!1,error:e.message})}),!0)),chrome.alarms.create("keep-alive",{periodInMinutes:.25}),chrome.alarms.onAlarm.addListener(e=>{"keep-alive"===e.name&&chrome.runtime.getPlatformInfo(()=>{})}),chrome.runtime.onSuspend.addListener(()=>{console.log("[HLTB] Service worker suspending...")})})();