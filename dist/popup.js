(()=>{"use strict";class e{constructor(){this.elements=new Map,this.DEFAULT_SETTINGS={enabled:!0,cacheEnabled:!0,cacheDuration:7,displayPosition:"above-purchase",theme:"auto"},this.cacheElements()}async initialize(){try{await Promise.all([this.initializeUI(),this.loadSettings(),this.loadStatistics()]),this.attachEventListeners()}catch(e){console.error("[Popup] Initialization failed:",e),this.showFeedback("Failed to initialize popup","error")}}cacheElements(){const e=["version","enabled","cache-enabled","cache-duration","display-position","theme","db-version","db-games","matches-count","match-rate","clear-cache","refresh-current","github-link","report-issue","suggest-game"];for(const t of e){const e=document.getElementById(t);e&&this.elements.set(t,e)}}getElement(e){return this.elements.get(e)||null}async initializeUI(){const e=chrome.runtime.getManifest(),t=this.getElement("version");t&&(t.textContent=`v${e.version}`)}async loadSettings(){try{const e=await chrome.storage.local.get(["enabled","cacheEnabled","cacheDuration","displayPosition","theme"]),t={enabled:!1!==e.enabled,cacheEnabled:!1!==e.cacheEnabled,cacheDuration:e.cacheDuration||this.DEFAULT_SETTINGS.cacheDuration,displayPosition:e.displayPosition||this.DEFAULT_SETTINGS.displayPosition,theme:e.theme||this.DEFAULT_SETTINGS.theme};this.renderSettings(t)}catch(e){console.error("[Popup] Failed to load settings:",e),this.renderSettings(this.DEFAULT_SETTINGS)}}renderSettings(e){this.setCheckbox("enabled",e.enabled),this.setCheckbox("cache-enabled",e.cacheEnabled),this.setSelect("cache-duration",e.cacheDuration.toString()),this.setSelect("display-position",e.displayPosition),this.setSelect("theme",e.theme)}async loadStatistics(){try{const[e,t]=await Promise.all([this.loadDatabaseInfo(),this.loadMatchStatistics()]);this.renderStatistics({database:e,matches:t})}catch(e){console.error("[Popup] Failed to load statistics:",e)}}async loadDatabaseInfo(){try{const e=await chrome.runtime.sendMessage({action:"getDatabaseInfo"});if(e?.success&&e.data)return{version:e.data.version||"1.0.0",gameCount:e.data.gameCount||0,lastUpdated:e.data.lastUpdated||(new Date).toISOString()}}catch(e){console.error("[Popup] Failed to load database info:",e)}return{version:"1.0.0",gameCount:100,lastUpdated:(new Date).toISOString()}}async loadMatchStatistics(){try{const e=await chrome.runtime.sendMessage({action:"getStats"});if(e?.success&&e.data){const t=e.data,a=t.totalRequests||0,s=(t.apiSuccesses||0)+(t.scraperSuccesses||0)+(t.fallbackSuccesses||0);return{totalMatches:s,matchRate:a>0?s/a:0}}}catch(e){console.error("[Popup] Failed to load match statistics:",e)}return{totalMatches:0,matchRate:0}}renderStatistics(e){this.setText("db-version",e.database.version),this.setText("db-games",e.database.gameCount.toString()),this.setText("matches-count",e.matches.totalMatches.toString()),this.setText("match-rate",`${Math.round(100*e.matches.matchRate)}%`)}attachEventListeners(){this.onToggleChange("enabled",async e=>{await chrome.storage.local.set({enabled:e}),await this.updateIcon(e),this.showFeedback(e?"Extension enabled":"Extension disabled","success")}),this.onToggleChange("cache-enabled",async e=>{await chrome.storage.local.set({cacheEnabled:e}),this.showFeedback(e?"Cache enabled":"Cache disabled","info")}),this.onSelectChange("cache-duration",async e=>{await chrome.storage.local.set({cacheDuration:parseInt(e)}),this.showFeedback(`Cache duration set to ${e} days`,"info")}),this.onSelectChange("display-position",async e=>{await chrome.storage.local.set({displayPosition:e}),this.showFeedback("Display position updated","info")}),this.onSelectChange("theme",async e=>{await chrome.storage.local.set({theme:e}),this.showFeedback(`Theme set to ${e}`,"success")}),this.onButtonClick("clear-cache",async()=>{await this.handleClearCache()}),this.onButtonClick("refresh-current",async()=>{await this.handleRefreshPage()}),this.onLinkClick("github-link",()=>{chrome.tabs.create({url:"https://github.com/yourusername/hltb-steam"})}),this.onLinkClick("report-issue",()=>{chrome.tabs.create({url:"https://github.com/yourusername/hltb-steam/issues/new"})}),this.onLinkClick("suggest-game",()=>{chrome.tabs.create({url:"https://github.com/yourusername/hltb-steam/blob/master/ADDING_GAMES.md"})})}async handleClearCache(){const e=this.getElement("clear-cache");if(!e)return;const t=e.textContent||"Clear Cache";try{e.textContent="Clearing...",e.disabled=!0,e.classList.add("btn-processing");const a=await chrome.runtime.sendMessage({action:"clearCache"});if(!a?.success)throw new Error(a?.error||"Unknown error");e.classList.remove("btn-processing"),e.classList.add("btn-success"),e.textContent="Cache Cleared!",this.showFeedback(`Cleared ${a.cleared||0} cache entries`,"success"),await this.loadStatistics(),setTimeout(()=>{e.classList.remove("btn-success"),e.textContent=t,e.disabled=!1},2e3)}catch(a){console.error("[Popup] Clear cache failed:",a),e.classList.remove("btn-processing"),e.classList.add("btn-error"),e.textContent="Failed",this.showFeedback("Failed to clear cache","error"),setTimeout(()=>{e.classList.remove("btn-error"),e.textContent=t,e.disabled=!1},2e3)}}async handleRefreshPage(){try{const e=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0];if(!e?.id)return void this.showFeedback("No active tab found","error");if(!this.isSteamPage(e.url))return void this.showFeedback("This action only works on Steam pages","info");await chrome.tabs.reload(e.id),window.close()}catch(e){console.error("[Popup] Refresh page failed:",e),this.showFeedback("Failed to refresh page","error")}}isSteamPage(e){return!!e&&(e.startsWith("https://store.steampowered.com/")||e.startsWith("https://steamcommunity.com/"))}async updateIcon(e){const t=e?"":"-disabled";try{await chrome.action.setIcon({path:{16:`icons/icon16${t}.png`,48:`icons/icon48${t}.png`,128:`icons/icon128${t}.png`}})}catch(e){console.error("[Popup] Failed to update icon:",e)}}showFeedback(e,t,a=3e3){const s=document.createElement("div");s.className=`feedback feedback-${t}`,s.textContent=e,s.setAttribute("role","status"),s.setAttribute("aria-live","polite");const i=document.querySelector(".popup-container");i&&i.firstChild&&(i.insertBefore(s,i.firstChild),requestAnimationFrame(()=>{s.classList.add("feedback-visible")}),setTimeout(()=>{s.classList.remove("feedback-visible"),setTimeout(()=>s.remove(),300)},a))}setCheckbox(e,t){const a=this.getElement(e);a&&"checkbox"===a.type&&(a.checked=t)}setSelect(e,t){const a=this.getElement(e);a&&"SELECT"===a.tagName&&(a.value=t)}setText(e,t){const a=this.getElement(e);a&&(a.textContent=t)}onToggleChange(e,t){const a=this.getElement(e);a&&a.addEventListener("change",e=>{t(e.target.checked)})}onSelectChange(e,t){const a=this.getElement(e);a&&a.addEventListener("change",e=>{t(e.target.value)})}onButtonClick(e,t){const a=this.getElement(e);a&&a.addEventListener("click",async()=>{await t()})}onLinkClick(e,t){const a=this.getElement(e);a&&a.addEventListener("click",e=>{e.preventDefault(),t()})}}document.addEventListener("DOMContentLoaded",()=>{(new e).initialize().catch(e=>{console.error("[Popup] Failed to initialize:",e)})})})();