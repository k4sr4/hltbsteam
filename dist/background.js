/*! For license information please see background.js.LICENSE.txt */
(()=>{function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,o,a,c,i=[],u=!0,s=!1;try{if(a=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;u=!1}else for(;!(u=(n=a.call(r)).done)&&(i.push(n.value),i.length!==t);u=!0);}catch(e){s=!0,o=e}finally{try{if(!u&&null!=r.return&&(c=r.return(),Object(c)!==c))return}finally{if(s)throw o}}return i}}(e,t)||function(e,t){if(e){if("string"==typeof e)return r(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function n(){var e,t,r="function"==typeof Symbol?Symbol:{},a=r.iterator||"@@iterator",c=r.toStringTag||"@@toStringTag";function i(r,n,a,c){var i=n&&n.prototype instanceof s?n:s,l=Object.create(i.prototype);return o(l,"_invoke",function(r,n,o){var a,c,i,s=0,l=o||[],f=!1,p={p:0,n:0,v:e,a:h,f:h.bind(e,4),d:function(t,r){return a=t,c=0,i=e,p.n=r,u}};function h(r,n){for(c=r,i=n,t=0;!f&&s&&!o&&t<l.length;t++){var o,a=l[t],h=p.p,m=a[2];r>3?(o=m===n)&&(i=a[(c=a[4])?5:(c=3,3)],a[4]=a[5]=e):a[0]<=h&&((o=r<2&&h<a[1])?(c=0,p.v=n,p.n=a[1]):h<m&&(o=r<3||a[0]>n||n>m)&&(a[4]=r,a[5]=n,p.n=m,c=0))}if(o||r>1)return u;throw f=!0,n}return function(o,l,m){if(s>1)throw TypeError("Generator is already running");for(f&&1===l&&h(l,m),c=l,i=m;(t=c<2?e:i)||!f;){a||(c?c<3?(c>1&&(p.n=-1),h(c,i)):p.n=i:p.v=i);try{if(s=2,a){if(c||(o="next"),t=a[o]){if(!(t=t.call(a,i)))throw TypeError("iterator result is not an object");if(!t.done)return t;i=t.value,c<2&&(c=0)}else 1===c&&(t=a.return)&&t.call(a),c<2&&(i=TypeError("The iterator does not provide a '"+o+"' method"),c=1);a=e}else if((t=(f=p.n<0)?i:r.call(n,p))!==u)break}catch(t){a=e,c=1,i=t}finally{s=1}}return{value:t,done:f}}}(r,a,c),!0),l}var u={};function s(){}function l(){}function f(){}t=Object.getPrototypeOf;var p=[][a]?t(t([][a]())):(o(t={},a,function(){return this}),t),h=f.prototype=s.prototype=Object.create(p);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,o(e,c,"GeneratorFunction")),e.prototype=Object.create(h),e}return l.prototype=f,o(h,"constructor",f),o(f,"constructor",l),l.displayName="GeneratorFunction",o(f,c,"GeneratorFunction"),o(h),o(h,c,"Generator"),o(h,a,function(){return this}),o(h,"toString",function(){return"[object Generator]"}),(n=function(){return{w:i,m}})()}function o(e,t,r,n){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}o=function(e,t,r,n){function c(t,r){o(e,t,function(e){return this._invoke(t,r,e)})}t?a?a(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(c("next",0),c("throw",1),c("return",2))},o(e,t,r,n)}function a(t,r,n){return(r=function(t){var r=function(t){if("object"!=e(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!=e(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==e(r)?r:r+""}(r))in t?Object.defineProperty(t,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[r]=n,t}function c(e,t,r,n,o,a,c){try{var i=e[a](c),u=i.value}catch(e){return void r(e)}i.done?t(u):Promise.resolve(u).then(n,o)}function i(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var a=e.apply(t,r);function i(e){c(a,n,o,i,u,"next",e)}function u(e){c(a,n,o,i,u,"throw",e)}i(void 0)})}}function u(){return(u=i(n().m(function e(t,r){var o,c,i,u,l,f,h,m;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,o=t.gameTitle,(c=t.appId)&&"string"==typeof c&&/^\d+$/.test(c)){e.n=1;break}return r({success:!1,error:"Invalid app ID"}),e.a(2);case 1:if(o&&"string"==typeof o&&!(o.length>200)){e.n=2;break}return r({success:!1,error:"Invalid game title"}),e.a(2);case 2:return i=c.replace(/[^0-9]/g,"").substring(0,20),u="hltb_".concat(i),e.n=3,chrome.storage.local.get(u);case 3:if(!(l=e.v)[u]||p(l[u])){e.n=4;break}return console.log("[HLTB] Using cached data for:",o.substring(0,50)),r({success:!0,data:l[u].data}),e.a(2);case 4:return console.log("[HLTB] Fetching fresh data for:",o.substring(0,50)),h={mainStory:s((f={mainStory:"12 Hours",mainExtra:"24 Hours",completionist:"48 Hours"}).mainStory),mainExtra:s(f.mainExtra),completionist:s(f.completionist)},e.n=5,chrome.storage.local.set(a({},u,{data:h,timestamp:Date.now(),gameTitle:o.substring(0,100)}));case 5:r({success:!0,data:h}),e.n=7;break;case 6:e.p=6,m=e.v,console.error("[HLTB] Error fetching data:",m),r({success:!1,error:"Failed to fetch data"});case 7:return e.a(2)}},e,null,[[0,6]])}))).apply(this,arguments)}function s(e){return"string"!=typeof e?"N/A":e.replace(/[^a-zA-Z0-9\s\-\.]/g,"").substring(0,50)||"N/A"}function l(){return(l=i(n().m(function e(t){var r,o;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,chrome.storage.local.get(["enabled","cacheEnabled","theme"]);case 1:r=e.v,t({success:!0,settings:{enabled:!1!==r.enabled,cacheEnabled:!1!==r.cacheEnabled,theme:r.theme||"auto"}}),e.n=3;break;case 2:e.p=2,o=e.v,console.error("[HLTB] Error getting settings:",o),t({success:!1,error:o.message});case 3:return e.a(2)}},e,null,[[0,2]])}))).apply(this,arguments)}function f(){return(f=i(n().m(function e(t){var r,o,a;return n().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,chrome.storage.local.get(null);case 1:return r=e.v,o=Object.keys(r).filter(function(e){return e.startsWith("hltb_")}),e.n=2,chrome.storage.local.remove(o);case 2:console.log("[HLTB] Cleared cache entries:",o.length),t({success:!0,cleared:o.length}),e.n=4;break;case 3:e.p=3,a=e.v,console.error("[HLTB] Error clearing cache:",a),t({success:!1,error:a.message});case 4:return e.a(2)}},e,null,[[0,3]])}))).apply(this,arguments)}function p(e){return Date.now()-e.timestamp>6048e5}function h(){return(h=i(n().m(function e(){var r,o,a,c,i,u,s;return n().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,chrome.storage.local.get(null);case 1:for(r=e.v,o=[],a=0,c=Object.entries(r);a<c.length;a++)i=t(c[a],2),u=i[0],s=i[1],u.startsWith("hltb_")&&p(s)&&o.push(u);if(!(o.length>0)){e.n=3;break}return e.n=2,chrome.storage.local.remove(o);case 2:console.log("[HLTB] Cleaned up expired cache entries:",o.length);case 3:return e.a(2)}},e)}))).apply(this,arguments)}console.log("[HLTB] Background service worker started"),chrome.runtime.onMessage.addListener(function(e,t,r){switch(console.log("[HLTB] Received message:",e.action),e.action){case"fetchHLTB":return function(e,t){u.apply(this,arguments)}(e,r),!0;case"getSettings":return function(e){l.apply(this,arguments)}(r),!0;case"clearCache":return function(e){f.apply(this,arguments)}(r),!0;default:console.warn("[HLTB] Unknown action:",e.action),r({success:!1,error:"Unknown action"})}}),chrome.alarms.create("cleanupCache",{periodInMinutes:60}),chrome.alarms.onAlarm.addListener(function(e){"cleanupCache"===e.name&&function(){h.apply(this,arguments)}()}),chrome.runtime.onInstalled.addListener(function(e){console.log("[HLTB] Extension installed:",e.reason),"install"===e.reason&&chrome.storage.local.set({enabled:!0,cacheEnabled:!0,theme:"auto",installDate:Date.now()})})})();