(()=>{"use strict";class e extends Error{constructor(e,t,r=!0,s){super(e),this.code=t,this.recoverable=r,this.userMessage=s,this.name="HLTBError",Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}}class t extends e{constructor(e,t){super(e,"DATABASE_LOAD_ERROR",!1,"Failed to load HLTB database. Extension may not work properly."),this.originalError=t,this.name="DatabaseLoadError"}}class r extends e{constructor(e,t){super(e,"PAGE_DETECTION_ERROR",!0,"Unable to detect game information on this Steam page."),this.detectionAttempts=t,this.name="SteamPageDetectionError"}}class s extends e{constructor(e,t){super(e,"DOM_INJECTION_ERROR",!0,"Unable to display HLTB data on this page."),this.attemptedSelectors=t,this.name="DOMInjectionError"}}class n extends e{constructor(e,t){super(e,"VALIDATION_ERROR",!1,"Invalid data detected."),this.field=t,this.name="ValidationError"}}function i(t){return t instanceof e}function a(e){return i(e)&&e.userMessage?e.userMessage:e instanceof Error?e.message:"An unexpected error occurred"}function o(e){return i(e)?e.code:e instanceof Error?e.name:"UNKNOWN_ERROR"}class c{static getInstance(e){return c.instance||(c.instance=new c(e)),c.instance}constructor(e){this.errorLog=[],this.config={maxLogSize:e?.maxLogSize??100,enableConsoleLogging:e?.enableConsoleLogging??!0,enableStoragePersistence:e?.enableStoragePersistence??!0,enableErrorReporting:e?.enableErrorReporting??!1},this.MAX_LOG_SIZE=this.config.maxLogSize,this.setupGlobalHandlers()}setupGlobalHandlers(){"undefined"!=typeof window&&(window.addEventListener("error",e=>{this.handleError(new Error(e.message),{type:"uncaught",filename:e.filename,lineno:e.lineno,colno:e.colno})}),window.addEventListener("unhandledrejection",e=>{const t=e.reason instanceof Error?e.reason:new Error(String(e.reason));this.handleError(t,{type:"unhandled_promise",promise:!0})})),"undefined"!=typeof chrome&&chrome?.runtime&&chrome.runtime.onError?.addListener(e=>{this.handleError(new Error(String(e)),{type:"chrome_runtime"})})}handleError(e,t={}){this.config.enableConsoleLogging,this.logError(e,t),i(e)?this.handleHLTBError(e):"NetworkError"===e.name?this.handleNetworkError(e):this.handleUnknownError(e),this.isCritical(e)&&this.config.enableErrorReporting&&this.reportError(e,t)}handleHLTBError(e){e.recoverable&&this.attemptRecovery(e)}handleNetworkError(e){}handleUnknownError(e){}attemptRecovery(e){switch(e.code){case"GAME_NOT_FOUND":const t=e;this.logMissingGame(t.gameTitle);break;case"PAGE_DETECTION_ERROR":case"DOM_INJECTION_ERROR":case"DATABASE_LOAD_ERROR":break;case"STORAGE_ERROR":const r=e;"get"!==r.operation&&"set"!==r.operation||this.clearCorruptedCache()}}logMissingGame(e){"undefined"!=typeof chrome&&chrome.storage&&chrome.storage.local.get("missing_games",t=>{const r=t.missing_games||[];if(!r.includes(e)){r.push(e);const t=r.slice(-100);chrome.storage.local.set({missing_games:t},()=>{})}})}clearCorruptedCache(){"undefined"!=typeof chrome&&chrome.storage&&chrome.storage.local.remove(["match_cache"],()=>{})}logError(e,t){const r={timestamp:Date.now(),message:e.message,stack:void 0,context:this.sanitizeContext(t),name:e.name,code:o(e),recoverable:!!i(e)&&e.recoverable,userMessage:a(e)};this.errorLog.push(r),this.errorLog.length>this.MAX_LOG_SIZE&&this.errorLog.shift(),this.persistErrorLog()}sanitizeContext(e){if(!e||"object"!=typeof e)return{};const t={},r=["type","action","code","recoverable"];for(const s of r)s in e&&(t[s]=String(e[s]).substring(0,100));return t}persistErrorLog(){if(this.config.enableStoragePersistence&&"undefined"!=typeof chrome&&chrome.storage)try{chrome.storage.local.set({errorLog:this.errorLog.slice(-50)}).catch(e=>{})}catch(e){}}isCritical(e){return e instanceof t||e instanceof n||e.message.includes("undefined")||e.message.includes("Cannot read")||e.message.includes("is not a function")||!0===e.stack?.includes("service-worker")}reportError(e,t){}showUserNotification(e,t="error"){"undefined"!=typeof chrome&&chrome.tabs&&chrome.tabs.query({active:!0,currentWindow:!0},r=>{r[0]?.id&&chrome.tabs.sendMessage(r[0].id,{action:"showNotification",message:e,type:t}).catch(()=>{})})}getErrorLog(){return[...this.errorLog]}clearErrorLog(){this.errorLog=[],this.config.enableStoragePersistence&&"undefined"!=typeof chrome&&chrome.storage&&chrome.storage.local.remove(["errorLog"])}getErrorStats(){const e={total:this.errorLog.length,critical:0,recoverable:0,byType:{}};for(const t of this.errorLog)t.recoverable?e.recoverable++:e.critical++,e.byType[t.code]=(e.byType[t.code]||0)+1;return e}}async function l(e,t,r="Operation timed out"){return Promise.race([e(),new Promise((e,s)=>setTimeout(()=>s(new Error(r)),t))])}class m{constructor(){this.metrics=[],this.memorySnapshots=[],this.timers=new Map,this.fpsFrameTimes=[],this.lastFrameTime=0,this.rafId=null,this.enabled=!0,this.MAX_METRICS=1e3,this.MAX_MEMORY_SNAPSHOTS=100,this.MAX_FPS_SAMPLES=60,this.STORAGE_KEY="hltb_performance_metrics"}static getInstance(){return m.instance||(m.instance=new m),m.instance}setEnabled(e){this.enabled=e,e||null===this.rafId||(cancelAnimationFrame(this.rafId),this.rafId=null)}startTiming(e){this.enabled&&this.timers.set(e,performance.now())}endTiming(e,t){if(!this.enabled)return 0;const r=this.timers.get(e);if(void 0===r)return 0;const s=performance.now()-r;return this.timers.delete(e),this.recordMetric({name:e,duration:s,timestamp:Date.now(),memoryUsed:this.getCurrentMemoryUsage(),metadata:t}),s}async measure(e,t,r){if(!this.enabled)return t();this.startTiming(e);try{const s=await t();return this.endTiming(e,r),s}catch(s){throw this.endTiming(e,{...r,error:!0}),s}}measureSync(e,t,r){if(!this.enabled)return t();this.startTiming(e);try{const s=t();return this.endTiming(e,r),s}catch(s){throw this.endTiming(e,{...r,error:!0}),s}}recordMetric(e){this.metrics.push(e),this.metrics.length>this.MAX_METRICS&&(this.metrics=this.metrics.slice(-this.MAX_METRICS))}takeMemorySnapshot(){if(!this.enabled)return null;if("memory"in performance&&performance.memory){const e=performance.memory,t={usedJSHeapSize:e.usedJSHeapSize,totalJSHeapSize:e.totalJSHeapSize,jsHeapSizeLimit:e.jsHeapSizeLimit,timestamp:Date.now()};return this.memorySnapshots.push(t),this.memorySnapshots.length>this.MAX_MEMORY_SNAPSHOTS&&(this.memorySnapshots=this.memorySnapshots.slice(-this.MAX_MEMORY_SNAPSHOTS)),t}return null}getCurrentMemoryUsage(){if("memory"in performance&&performance.memory)return performance.memory.usedJSHeapSize}startFPSMonitoring(){if(!this.enabled||null!==this.rafId)return;this.lastFrameTime=performance.now(),this.fpsFrameTimes=[];const e=()=>{const t=performance.now(),r=t-this.lastFrameTime;if(this.lastFrameTime=t,r>0){const e=1e3/r;this.fpsFrameTimes.push(e),this.fpsFrameTimes.length>this.MAX_FPS_SAMPLES&&this.fpsFrameTimes.shift()}this.rafId=requestAnimationFrame(e)};this.rafId=requestAnimationFrame(e)}stopFPSMonitoring(){return null!==this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.getFPSMetrics()}getFPSMetrics(){return 0===this.fpsFrameTimes.length?null:{current:this.fpsFrameTimes[this.fpsFrameTimes.length-1],average:this.fpsFrameTimes.reduce((e,t)=>e+t,0)/this.fpsFrameTimes.length,min:Math.min(...this.fpsFrameTimes),max:Math.max(...this.fpsFrameTimes),samples:this.fpsFrameTimes.length}}getReport(){const e=this.metrics.reduce((e,t)=>e+t.duration,0),t=this.metrics.length>0?e/this.metrics.length:0,r=[...this.metrics].sort((e,t)=>t.duration-e.duration),s=r[0]||null,n=r[r.length-1]||null,i=this.memorySnapshots.map(e=>e.usedJSHeapSize),a=i.length>0?Math.max(...i):0,o=i.length>0?i.reduce((e,t)=>e+t,0)/i.length:0;return{metrics:this.metrics,memory:this.memorySnapshots,fps:this.getFPSMetrics()||{current:0,average:0,min:0,max:0,samples:0},summary:{totalDuration:e,averageDuration:t,slowestOperation:s,fastestOperation:n,memoryPeak:a,memoryAverage:o}}}logMetrics(e){(e?this.metrics.filter(t=>t.name.includes(e)):this.metrics).length}logSummary(){const e=this.getReport();e.summary.slowestOperation,e.summary.fastestOperation,e.summary.memoryPeak,e.fps.samples}async saveToStorage(){if(this.enabled)try{const e=this.getReport();await chrome.storage.local.set({[this.STORAGE_KEY]:{timestamp:Date.now(),summary:e.summary,recentMetrics:this.metrics.slice(-50),fps:e.fps}})}catch(e){}}async loadFromStorage(){if(this.enabled)try{const e=await chrome.storage.local.get(this.STORAGE_KEY);e[this.STORAGE_KEY]&&e[this.STORAGE_KEY]}catch(e){}}clear(){this.metrics=[],this.memorySnapshots=[],this.timers.clear(),this.fpsFrameTimes=[],null!==this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null)}getMetricsByName(e){return this.metrics.filter(t=>t.name.includes(e))}getAverageDuration(e){const t=this.metrics.filter(t=>t.name===e);return 0===t.length?0:t.reduce((e,t)=>e+t.duration,0)/t.length}checkTargets(e){const t={};for(const[r,s]of Object.entries(e)){const e=this.getAverageDuration(r);t[r]=e<=s}return t}detectMemoryLeaks(){if(this.memorySnapshots.length<10)return{detected:!1,trend:"unknown",growth:0};const e=this.memorySnapshots.slice(-20),t=e.slice(0,10),r=e.slice(10),s=t.reduce((e,t)=>e+t.usedJSHeapSize,0)/t.length,n=(r.reduce((e,t)=>e+t.usedJSHeapSize,0)/r.length-s)/s*100;let i;return i=n>5?"increasing":n<-5?"decreasing":"stable",{detected:n>10,trend:i,growth:n}}}m.instance=null,m.getInstance();const h=new class{constructor(){this.mutationObserver=null,this.containerElement=null,this.metrics=null,this.lastUrl=window.location.href,this.errorHandler=c.getInstance({enableConsoleLogging:!0,enableStoragePersistence:!0}),this.setupMessageListener(),this.log("Content script loaded on:",this.lastUrl)}async initialize(){await async function(e,t,r){try{return await e()}catch(s){return void(r||(e=>c.getInstance().handleError(e)))(s)}}(async()=>this.initializeInternal(),0,e=>{this.errorHandler.handleError(e),this.injectError(e.message)})}async initializeInternal(){const e=performance.now();if(!this.isGamePage())return void this.log("Not a game page, skipping initialization");const t=await l(async()=>this.sendMessage({action:"getSettings"}),5e3,"Settings check timed out");if(!t.success||!t.settings?.enabled)return void this.log("Extension is disabled");await this.waitForPageStability();const s=this.extractGameInfo();if(!s)throw new r("Could not extract game info from Steam page",4);this.log("Game detected:",s);const n=await l(async()=>this.sendMessage({action:"fetchHLTB",gameTitle:s.title,appId:s.appId}),1e4,"HLTB data fetch timed out");if(n.success&&n.data){this.log("Data received:",n.data);const t=performance.now();this.injectHLTBData(n.data);const r=performance.now();this.metrics={startTime:e,injectionTime:t-e,totalTime:r-e},this.log("Performance metrics:",this.metrics)}else{const e=n.error||"Failed to load completion times";this.errorHandler.handleError(new Error(e)),this.injectError(e)}}async waitForPageStability(){this.log("Waiting for page stability...");let e=0;for(;e<20;){const t=document.querySelector(".game_area_purchase"),r=document.querySelector(".game_details"),s=document.querySelector(".page_content");if(t||r||s)return await this.sleep(500),void this.log("Page appears stable, ready to inject");await this.sleep(250),e++}this.log("Timed out waiting for page stability, injecting anyway")}sleep(e){return new Promise(t=>setTimeout(t,e))}isGamePage(){const e=window.location.href;return e.includes("store.steampowered.com/app/")||e.includes("steamcommunity.com/app/")}extractGameInfo(){const e=window.location.href,t=e.match(/\/app\/(\d+)/);if(!t)return null;const r=t[1];let s="";const n=e.match(/\/app\/\d+\/([^\/\?#]+)/);if(n&&(s=this.cleanUrlTitle(n[1])),!s){const e=document.querySelector("#appHubAppName");e?.textContent&&(s=e.textContent.trim())}if(!s){const e=document.querySelector('meta[property="og:title"]');e?.content&&(s=this.cleanMetaTitle(e.content))}return s||(s=this.cleanMetaTitle(document.title)),s?{appId:r,title:s}:null}cleanUrlTitle(e){return e.replace(/_/g," ").replace(/%20/g," ").trim()}cleanMetaTitle(e){return e.replace(/ on Steam$/,"").replace(/^Save \d+% on /,"").trim()}injectHLTBData(e){this.cleanup();const t=e=>null==e||0===e?"--":e+(1===e?" Hour":" Hours"),r=document.createElement("div");r.className="hltb-container",this.containerElement=r,e.source&&r.setAttribute("data-source",e.source),e.confidence&&r.setAttribute("data-confidence",e.confidence);const s=document.createElement("div");s.className="hltb-header";const n=document.createElement("span");n.className="hltb-logo",n.textContent="HLTB";const i=document.createElement("span");if(i.className="hltb-title",i.textContent="HowLongToBeat",e.source&&"api"!==e.source){const t=document.createElement("span");t.className="hltb-source";const r="cache"===e.source?"cached":"scraper"===e.source?"scraped":"fallback"===e.source?"estimated":"database"===e.source?"database":"";r&&(t.textContent=`(${r})`,i.appendChild(document.createTextNode(" ")),i.appendChild(t))}s.appendChild(n),s.appendChild(i);const a=document.createElement("div");a.className="hltb-times";const o=[{label:"Main Story",value:t(e.mainStory)},{label:"Main + Extra",value:t(e.mainExtra)},{label:"Completionist",value:t(e.completionist)}];if(null===e.mainStory&&null===e.mainExtra&&null===e.completionist){const e=document.createElement("div");e.className="hltb-multiplayer-notice",e.textContent="Multiplayer Game - No completion times",a.appendChild(e)}else o.forEach(({label:e,value:t})=>{const r=document.createElement("div");r.className="hltb-time-box","--"===t&&r.classList.add("hltb-no-data");const s=document.createElement("div");s.className="hltb-label",s.textContent=e;const n=document.createElement("div");n.className="hltb-hours",n.textContent=t,r.appendChild(s),r.appendChild(n),a.appendChild(r)});r.appendChild(s),r.appendChild(a),this.injectIntoPage(r)}injectError(e){this.cleanup();const t=document.createElement("div");t.className="hltb-container hltb-error-container",this.containerElement=t;const r=document.createElement("div");r.className="hltb-header";const s=document.createElement("span");s.className="hltb-title",s.textContent="HowLongToBeat",r.appendChild(s);const n=document.createElement("div");n.className="hltb-error",n.textContent=e,t.appendChild(r),t.appendChild(n),this.injectIntoPage(t)}injectIntoPage(e){const t=[".game_area_purchase",".game_area_purchase_game",".apphub_AppName",".apphub_HomeHeader",".rightcol",".game_meta_data","#appHubAppName"];let r=!1;for(const s of t){const t=document.querySelector(s);if(t){s.includes("apphub")||s.includes("appHub")?t.parentNode?.insertBefore(e,t.nextSibling):t.parentNode?.insertBefore(e,t),this.log("UI injected successfully at:",s),r=!0;break}}if(!r){const e=new s("Could not find suitable injection point on page",t);throw this.errorHandler.handleError(e),e}}setupMessageListener(){chrome.runtime.onMessage.addListener((e,t,r)=>("showNotification"===e.action&&(this.showNotification(e.message,e.type),r({success:!0})),!0))}showNotification(e,t="info"){const r=document.createElement("div");r.className=`hltb-notification hltb-notification-${t}`,r.textContent=e,document.body.appendChild(r),setTimeout(()=>r.classList.add("hltb-notification-visible"),10),setTimeout(()=>{r.classList.remove("hltb-notification-visible"),setTimeout(()=>r.remove(),300)},5e3)}async sendMessage(e){try{return await chrome.runtime.sendMessage(e)||{success:!1,error:"No response from background service"}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to communicate with extension"}}}setupNavigationObserver(){this.mutationObserver=new MutationObserver(()=>{const e=window.location.href;e!==this.lastUrl&&(this.lastUrl=e,this.log("Navigation detected:",e),this.cleanup(),this.isGamePage()&&(this.log("Re-initializing on new game page"),this.initialize()))}),this.mutationObserver.observe(document.body,{childList:!0,subtree:!0}),this.log("Navigation observer set up")}cleanup(){this.containerElement&&this.containerElement.parentNode&&(this.containerElement.parentNode.removeChild(this.containerElement),this.containerElement=null)}destroy(){this.cleanup(),this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null),this.log("Content script destroyed")}log(e,t){}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{h.initialize(),h.setupNavigationObserver()}):(h.initialize(),h.setupNavigationObserver()),window.addEventListener("unload",()=>{h.destroy()})})();