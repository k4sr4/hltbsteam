(()=>{"use strict";class e{constructor(e,t){this.maxTokens=e,this.windowMs=t,this.tokens=e,this.lastRefill=Date.now()}async wait(){if(this.refill(),this.tokens>0)return void this.tokens--;const e=this.windowMs-(Date.now()-this.lastRefill);await new Promise(t=>setTimeout(t,e)),this.refill(),this.tokens--}refill(){const e=Date.now();e-this.lastRefill>=this.windowMs&&(this.tokens=this.maxTokens,this.lastRefill=e)}}const t=new class{constructor(){this.CACHE_KEY="hltb_cache",this.cache=new Map,this.cacheDuration=6048e5,this.loadCache()}async loadCache(){const e=await chrome.storage.local.get(this.CACHE_KEY);e[this.CACHE_KEY]&&(this.cache=new Map(Object.entries(e[this.CACHE_KEY])),this.cleanExpired())}async saveCache(){await chrome.storage.local.set({[this.CACHE_KEY]:Object.fromEntries(this.cache)})}async get(e){const t=this.cache.get(e);return t?Date.now()-t.timestamp>this.cacheDuration?(this.cache.delete(e),await this.saveCache(),null):(t.hits++,await this.saveCache(),t.data):null}async set(e,t){this.cache.set(e,{data:t,timestamp:Date.now(),hits:0}),this.cache.size>1e3&&this.evictLRU(),await this.saveCache()}cleanExpired(){const e=Date.now();for(const[t,a]of this.cache.entries())e-a.timestamp>this.cacheDuration&&this.cache.delete(t)}evictLRU(){let e="",t=1/0;for(const[a,s]of this.cache.entries()){const r=s.hits+(Date.now()-s.timestamp)/1e6;r<t&&(t=r,e=a)}e&&this.cache.delete(e)}async getStats(){const e=Array.from(this.cache.values());return 0===e.length?{size:0,hits:0,oldestEntry:null,totalSize:0}:{size:this.cache.size,hits:e.reduce((e,t)=>e+t.hits,0),oldestEntry:Math.min(...e.map(e=>e.timestamp)),totalSize:JSON.stringify(Object.fromEntries(this.cache)).length}}async clear(){this.cache.clear(),await chrome.storage.local.remove(this.CACHE_KEY)}},a=new class{constructor(){this.queue=[],this.processing=!1,this.rateLimiter=new e(10,6e4)}async enqueue(e){return new Promise((t,a)=>{this.queue.push(async()=>{try{await this.rateLimiter.wait();const a=await e();t(a)}catch(e){a(e)}}),this.process()})}async process(){if(!this.processing&&0!==this.queue.length){for(this.processing=!0;this.queue.length>0;){const e=this.queue.shift();e&&await e()}this.processing=!1}}async flush(){return Promise.all(this.queue.map(e=>e()))}},s=new class{constructor(e,t){this.cacheService=e,this.queueService=t,this.API_URL="https://howlongtobeat.com/api/search"}async getGameData(e,t){const a=(t||e).replace(/[^a-zA-Z0-9_-]/g,"").substring(0,50),s=await this.cacheService.get(a);return s?(console.log("[HLTB] Cache hit:",e),s):this.queueService.enqueue(async()=>{const t=await this.fetchFromHLTB(e);return t&&await this.cacheService.set(a,t),t})}async fetchFromHLTB(e){console.log("[HLTB] Fetching data for:",e);const t={searchType:"games",searchTerms:[e],searchPage:1,size:20,searchOptions:{games:{userId:0,platform:"",sortCategory:"popular",rangeCategory:"main",rangeTime:{min:0,max:0},gameplay:{perspective:"",flow:"",genre:""},modifier:""},users:{sortCategory:"postcount"},filter:"",sort:0,randomizer:0}};try{const a=await fetch(this.API_URL,{method:"POST",headers:{"Content-Type":"application/json",Referer:"https://howlongtobeat.com"},body:JSON.stringify(t)});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);const s=(await a.json()).data;if(!s||0===s.length)return console.log("[HLTB] No results found for:",e),this.getFallbackData(e);const r=this.findBestMatch(e,s);return r?this.parseGameData(r):this.getFallbackData(e)}catch(t){return console.error("[HLTB] Fetch error:",t),this.getFallbackData(e)}}findBestMatch(e,t){const a=this.normalizeTitle(e);let s=t[0],r=0;for(const e of t){const t=this.normalizeTitle(e.game_name),i=this.calculateSimilarity(a,t);i>r&&(r=i,s=e)}return r<.5?null:s}normalizeTitle(e){return e.toLowerCase().replace(/[^a-z0-9]/g,"").trim()}calculateSimilarity(e,t){if(e===t)return 1;const a=e.length>t.length?e:t,s=e.length>t.length?t:e;if(0===a.length)return 0;const r=this.levenshteinDistance(a,s);return(a.length-r)/a.length}levenshteinDistance(e,t){const a=[];for(let e=0;e<=t.length;e++)a[e]=[e];for(let t=0;t<=e.length;t++)a[0][t]=t;for(let s=1;s<=t.length;s++)for(let r=1;r<=e.length;r++)t.charAt(s-1)===e.charAt(r-1)?a[s][r]=a[s-1][r-1]:a[s][r]=Math.min(a[s-1][r-1]+1,a[s][r-1]+1,a[s-1][r]+1);return a[t.length][e.length]}parseGameData(e){const t=e=>e>0?Math.round(e/60):null;return{mainStory:t(e.comp_main),mainExtra:t(e.comp_plus),completionist:t(e.comp_100),allStyles:t(e.comp_all)}}async getFallbackData(e){console.log("[HLTB] Using fallback data for:",e);const t={portal:{mainStory:3,mainExtra:4,completionist:8,allStyles:4},portal2:{mainStory:8,mainExtra:10,completionist:21,allStyles:9},halflife:{mainStory:12,mainExtra:13,completionist:15,allStyles:12},halflife2:{mainStory:13,mainExtra:15,completionist:20,allStyles:13},hades:{mainStory:22,mainExtra:45,completionist:95,allStyles:55},eldenring:{mainStory:55,mainExtra:77,completionist:133,allStyles:96},witcher3:{mainStory:51,mainExtra:103,completionist:173,allStyles:101}},a=this.normalizeTitle(e);for(const[e,s]of Object.entries(t))if(a.includes(e)||e.includes(a))return s;return{mainStory:12,mainExtra:24,completionist:48,allStyles:24}}async batchFetch(e){const t=new Map;for(const a of e){const e=await this.cacheService.get(a.appId);e&&t.set(a.appId,e)}const a=e.filter(e=>!t.has(e.appId));for(const e of a){const a=await this.getGameData(e.title,e.appId);t.set(e.appId,a)}return Object.fromEntries(t)}async getCacheStats(){return this.cacheService.getStats()}}(t,a),r=new class{constructor(e){this.hltbService=e}async handle(e,t){switch(e.action){case"fetchHLTB":return this.handleFetchHLTB(e);case"clearCache":return this.handleClearCache();case"getCacheStats":return this.handleGetCacheStats();case"batchFetch":return this.handleBatchFetch(e);case"getSettings":return this.handleGetSettings();default:throw new Error(`Unknown action: ${e.action}`)}}async handleFetchHLTB(e){const{gameTitle:t,appId:a}=e;if(!t)return{success:!1,error:"Game title is required"};if(a&&("string"!=typeof a||!/^\d+$/.test(a)))return{success:!1,error:"Invalid app ID"};if("string"!=typeof t||t.length>200)return{success:!1,error:"Invalid game title"};try{return{success:!0,data:await this.hltbService.getGameData(t,a)}}catch(e){return console.error("[HLTB] Fetch error:",e),{success:!1,error:e.message}}}async handleClearCache(){return await chrome.storage.local.remove(["hltb_cache"]),{success:!0,message:"Cache cleared"}}async handleGetCacheStats(){return{success:!0,data:await this.hltbService.getCacheStats()}}async handleGetSettings(){try{const e=await chrome.storage.local.get(["enabled","cacheEnabled","theme","cacheDurationHours"]);return{success:!0,settings:{enabled:!1!==e.enabled,cacheEnabled:!1!==e.cacheEnabled,theme:e.theme||"auto",cacheDurationHours:e.cacheDurationHours||168}}}catch(e){return console.error("[HLTB] Error getting settings:",e),{success:!1,error:e.message}}}async handleBatchFetch(e){const{games:t}=e;return Array.isArray(t)?{success:!0,data:await this.hltbService.batchFetch(t)}:{success:!1,error:"Games array is required"}}}(s);chrome.runtime.onInstalled.addListener(async e=>{if(console.log("[HLTB] Extension installed:",e.reason),"install"===e.reason)await chrome.storage.local.set({enabled:!0,cacheEnabled:!0,cacheDurationHours:168,rateLimit:{maxRequests:10,windowMs:6e4}});else if("update"===e.reason){const t=e.previousVersion;console.log("[HLTB] Updated from version:",t)}}),chrome.runtime.onMessage.addListener((e,t,a)=>(console.log("[HLTB] Message received:",e.action),r.handle(e,t).then(a).catch(e=>{console.error("[HLTB] Message handler error:",e),a({success:!1,error:e.message})}),!0)),chrome.alarms.create("keep-alive",{periodInMinutes:.25}),chrome.alarms.onAlarm.addListener(e=>{"keep-alive"===e.name&&chrome.runtime.getPlatformInfo(()=>{})}),chrome.runtime.onSuspend.addListener(()=>{console.log("[HLTB] Service worker suspending..."),a.flush()})})();