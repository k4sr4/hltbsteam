(()=>{"use strict";var t,e,a={},i={};function s(t){var e=i[t];if(void 0!==e)return e.exports;var l=i[t]={exports:{}};return a[t](l,l.exports,s),l.exports}s.m=a,s.d=(t,e)=>{for(var a in e)s.o(e,a)&&!s.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:e[a]})},s.f={},s.e=t=>Promise.all(Object.keys(s.f).reduce((e,a)=>(s.f[a](t,e),e),[])),s.u=t=>t+".js",s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),t={},e="hltb-steam-extension:",s.l=(a,i,l,n)=>{if(t[a])t[a].push(i);else{var r,o;if(void 0!==l)for(var c=document.getElementsByTagName("script"),h=0;h<c.length;h++){var m=c[h];if(m.getAttribute("src")==a||m.getAttribute("data-webpack")==e+l){r=m;break}}r||(o=!0,(r=document.createElement("script")).charset="utf-8",r.timeout=120,s.nc&&r.setAttribute("nonce",s.nc),r.setAttribute("data-webpack",e+l),r.src=a),t[a]=[i];var d=(e,i)=>{r.onerror=r.onload=null,clearTimeout(u);var s=t[a];if(delete t[a],r.parentNode&&r.parentNode.removeChild(r),s&&s.forEach(t=>t(i)),e)return e(i)},u=setTimeout(d.bind(null,void 0,{type:"timeout",target:r}),12e4);r.onerror=d.bind(null,r.onerror),r.onload=d.bind(null,r.onload),o&&document.head.appendChild(r)}},(()=>{var t;s.g.importScripts&&(t=s.g.location+"");var e=s.g.document;if(!t&&e&&(e.currentScript&&"SCRIPT"===e.currentScript.tagName.toUpperCase()&&(t=e.currentScript.src),!t)){var a=e.getElementsByTagName("script");if(a.length)for(var i=a.length-1;i>-1&&(!t||!/^http(s?):/.test(t));)t=a[i--].src}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),s.p=t})(),(()=>{var t={471:0};s.f.j=(e,a)=>{var i=s.o(t,e)?t[e]:void 0;if(0!==i)if(i)a.push(i[2]);else{var l=new Promise((a,s)=>i=t[e]=[a,s]);a.push(i[2]=l);var n=s.p+s.u(e),r=new Error;s.l(n,a=>{if(s.o(t,e)&&(0!==(i=t[e])&&(t[e]=void 0),i)){var l=a&&("load"===a.type?"missing":a.type),n=a&&a.target&&a.target.src;r.message="Loading chunk "+e+" failed.\n("+l+": "+n+")",r.name="ChunkLoadError",r.type=l,r.request=n,i[1](r)}},"chunk-"+e,e)}};var e=(e,a)=>{var i,l,[n,r,o]=a,c=0;if(n.some(e=>0!==t[e])){for(i in r)s.o(r,i)&&(s.m[i]=r[i]);o&&o(s)}for(e&&e(a);c<n.length;c++)l=n[c],s.o(t,l)&&t[l]&&t[l][0](),t[l]=0},a=self.webpackChunkhltb_steam_extension=self.webpackChunkhltb_steam_extension||[];a.forEach(e.bind(null,0)),a.push=e.bind(null,a.push.bind(a))})();class l extends Error{constructor(t=60){super(`Rate limit exceeded. Retry after ${t} seconds`),this.name="RateLimitError",this.retryAfter=t,this.resetTime=new Date(Date.now()+1e3*t)}}class n extends Error{constructor(t,e,a){super(t),this.name="NetworkError",this.statusCode=e,this.originalError=a}}class r{constructor(t=3,e=1e3,a=3e4){this.retryCount=new Map,this.lastAttempt=new Map,this.maxRetries=t,this.baseDelay=e,this.maxDelay=a}async executeWithRetry(t,e,a){const i=this.retryCount.get(t)||0;try{const a=await e();return this.retryCount.delete(t),this.lastAttempt.delete(t),a}catch(s){if(i>=this.maxRetries)throw this.retryCount.delete(t),this.lastAttempt.delete(t),s;if(!(a?a(s):this.isDefaultRetriableError(s)))throw s;const l=this.calculateDelay(i);return this.retryCount.set(t,i+1),this.lastAttempt.set(t,Date.now()),console.log(`[RetryManager] Attempt ${i+1}/${this.maxRetries} for ${t}. Waiting ${l}ms`),await this.delay(l),this.executeWithRetry(t,e,a)}}calculateDelay(t){const e=Math.min(this.baseDelay*Math.pow(2,t),this.maxDelay),a=.25*Math.random()*e;return Math.floor(e+a)}delay(t){return new Promise(e=>setTimeout(e,t))}isDefaultRetriableError(t){if(t instanceof n){const e=t.statusCode;return!e||e>=500||429===e||0===e}return t instanceof l||"NetworkError"===t.name||"FetchError"===t.name||"AbortError"===t.name}reset(t){t?(this.retryCount.delete(t),this.lastAttempt.delete(t)):(this.retryCount.clear(),this.lastAttempt.clear())}}class o{constructor(t={}){this.options=t,this.API_ENDPOINT="https://howlongtobeat.com/api/locate/5d6cf2e5eb308ba8",this.rateLimitReset=null,this.retryManager=new r(t.maxRetries||3,t.baseDelay||1e3,t.maxDelay||3e4)}async searchGames(t){if(this.rateLimitReset&&this.rateLimitReset>new Date){const t=Math.ceil((this.rateLimitReset.getTime()-Date.now())/1e3);throw new l(t)}const e=this.buildSearchPayload(t);return this.retryManager.executeWithRetry(`search:${t}`,async()=>{const t=await this.makeRequest(e);return this.parseResponse(t)})}async getGameData(t){const e=await this.searchGames(t);return e&&0!==e.length?await this.findBestMatch(t,e):null}buildSearchPayload(t){return{searchType:"games",searchTerms:t.split(" ").filter(t=>t.length>0),searchPage:1,size:20,searchOptions:{games:{userId:0,platform:"",sortCategory:"popular",rangeCategory:"main"},users:{sortCategory:"postcount"},lists:{sortCategory:"follows"},filter:"",sort:0,randomizer:0},useCache:!0}}async makeRequest(t){const e=new AbortController,a=this.options.timeout||3e4,i=setTimeout(()=>e.abort(),a);try{const a=await fetch(this.API_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","Accept-Language":"en-US,en;q=0.9",Referer:"https://howlongtobeat.com",Origin:"https://howlongtobeat.com","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36","Cache-Control":"no-cache",Pragma:"no-cache"},body:JSON.stringify(t),signal:e.signal});if(clearTimeout(i),429===a.status){const t=this.parseRetryAfter(a.headers);throw this.rateLimitReset=new Date(Date.now()+1e3*t),new l(t)}if(!a.ok)throw new n(`HTTP ${a.status}: ${a.statusText}`,a.status);try{return await a.json()}catch(t){throw new n("Failed to parse response JSON",a.status,t)}}catch(t){if(clearTimeout(i),t instanceof Error&&"AbortError"===t.name)throw new n("Request timeout",void 0,t);if(t instanceof l||t instanceof n)throw t;throw new n("Network request failed",void 0,t)}}parseRetryAfter(t){const e=t.get("Retry-After");if(!e)return 60;const a=parseInt(e,10);if(!isNaN(a))return a;const i=new Date(e);return isNaN(i.getTime())?60:Math.max(0,Math.ceil((i.getTime()-Date.now())/1e3))}parseResponse(t){return t.data&&Array.isArray(t.data)?t.data.map(t=>this.parseGameData(t)):[]}parseGameData(t){return{mainStory:this.parseTimeValue(t.comp_main),mainExtra:this.parseTimeValue(t.comp_plus),completionist:this.parseTimeValue(t.comp_100),allStyles:this.parseTimeValue(t.comp_all),gameId:t.game_id,gameName:t.game_name,imageUrl:t.game_image?`https://howlongtobeat.com/games/${t.game_image}`:void 0,playerCounts:{main:t.comp_main_count||0,extra:t.comp_plus_count||0,completionist:t.comp_100_count||0,all:t.comp_all_count||0}}}parseTimeValue(t){if(null==t||0===t)return null;let e;if("string"==typeof t){if(e=parseFloat(t),isNaN(e))return null}else e=Number(t);const a=e/3600;return a<10?Math.round(10*a)/10:Math.round(a)}async findBestMatch(t,e){if(0===e.length)return null;const{titleMatcher:a}=await s.e(147).then(s.bind(s,147)),i=e.map(t=>({gameId:t.gameId,gameName:t.gameName,gameImage:t.gameImage,mainStory:t.mainStory,mainExtra:t.mainExtra,completionist:t.completionist,allStyles:t.allStyles})),l=await a.findBestMatch(t,i);return l&&l.match?l.skip?(console.log(`[HLTBApiClient] Skipping "${t}": ${l.reason}`),null):(console.log(`[HLTBApiClient] Matched "${t}" -> "${l.match.gameName}" (${(100*l.confidence).toFixed(1)}% via ${l.method})`),e.find(t=>t.gameId===l.match.gameId)||null):(console.log(`[HLTBApiClient] No match found for "${t}"`),null)}async batchFetch(t){const e=new Map,a=[];for(let e=0;e<t.length;e+=5)a.push(t.slice(e,e+5));for(const t of a){const i=t.map(async t=>{try{const a=await this.getGameData(t.title);e.set(t.id,a)}catch(a){if(console.error(`[HLTBApiClient] Failed to fetch data for ${t.title}:`,a),e.set(t.id,null),a instanceof l)throw a}});try{await Promise.all(i)}catch(t){if(t instanceof l){console.warn("[HLTBApiClient] Rate limited during batch fetch");break}throw t}a.indexOf(t)<a.length-1&&await this.delay(500)}return e}delay(t){return new Promise(e=>setTimeout(e,t))}clearRateLimit(){this.rateLimitReset=null}resetRetries(t){this.retryManager.reset(t)}}new o({maxRetries:3,baseDelay:1e3,maxDelay:3e4,timeout:3e4});class c extends Error{constructor(t,e,a){super(t),this.name="ScrapingError",this.statusCode=e,this.url=a}}const h=new class{constructor(){this.BASE_URL="https://howlongtobeat.com",this.SEARCH_URL="https://howlongtobeat.com/search_results",this.USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",this.SELECTORS={searchResults:".search_list_details",gameCard:".search_list_details_block",gameName:".search_list_details_block h3 a",gameNameAlt:".search_list_details_block .search_list_details_block_title",gameImage:"img.search_list_image",gameLink:"h3 a",timeContainer:".search_list_tidbit",timeLabel:".search_list_tidbit_short",timeValue:".search_list_tidbit_long",noResults:".search_list_no_results"}}async scrapeGameData(t){console.log("[HLTB Scraper] Scraping data for:",t);try{const e=await this.fetchSearchResults(t);if(!e)throw new c("Failed to fetch HTML content");const a=this.parseSearchResults(e,t);return console.log(`[HLTB Scraper] Found ${a.games.length} games for "${t}"`),a}catch(t){return console.error("[HLTB Scraper] Error:",t),null}}async fetchSearchResults(t){const e=`${this.SEARCH_URL}?page=1&length=20&sort=name&search=${encodeURIComponent(t)}`;try{const t=await fetch(e,{method:"GET",headers:{"User-Agent":this.USER_AGENT,Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8","Accept-Language":"en-US,en;q=0.5","Accept-Encoding":"gzip, deflate, br",Connection:"keep-alive","Upgrade-Insecure-Requests":"1","Sec-Fetch-Dest":"document","Sec-Fetch-Mode":"navigate","Sec-Fetch-Site":"none","Cache-Control":"max-age=0",Referer:"https://howlongtobeat.com/"}});if(!t.ok)throw new c(`HTTP ${t.status}: ${t.statusText}`,t.status,e);const a=await t.text();if(!a||a.length<100)throw new c("Received empty or invalid HTML response");return a}catch(t){if(t instanceof c)throw t;throw new c(`Network error: ${t instanceof Error?t.message:"Unknown error"}`,void 0,e)}}parseSearchResults(t,e){const a=(new DOMParser).parseFromString(t,"text/html");if(a.querySelector(this.SELECTORS.noResults))return console.log("[HLTB Scraper] No results found"),{games:[],totalResults:0,searchTerm:e,timestamp:Date.now()};const i=a.querySelectorAll(this.SELECTORS.gameCard);console.log(`[HLTB Scraper] Found ${i.length} game cards`);const s=[];return i.forEach((t,e)=>{try{const e=this.parseGameCard(t);e&&s.push(e)}catch(t){console.warn(`[HLTB Scraper] Failed to parse game card ${e}:`,t)}}),{games:s,totalResults:s.length,searchTerm:e,timestamp:Date.now()}}parseGameCard(t){try{const e=t.querySelector(this.SELECTORS.gameName)||t.querySelector(this.SELECTORS.gameNameAlt);if(!e)return console.warn("[HLTB Scraper] No game name found in card"),null;const a=this.cleanText(e.textContent||"");if(!a)return console.warn("[HLTB Scraper] Empty game name"),null;const i=t.querySelector(this.SELECTORS.gameLink);let s=null,l=null;i&&i.href&&(l=this.normalizeUrl(i.href),s=this.extractGameIdFromUrl(l));const n=t.querySelector(this.SELECTORS.gameImage);let r=null;return n&&n.src&&(r=this.normalizeUrl(n.src)),{id:s,name:a,image:r,url:l,...this.parseCompletionTimes(t)}}catch(t){return console.error("[HLTB Scraper] Error parsing game card:",t),null}}parseCompletionTimes(t){const e={mainStory:null,mainExtra:null,completionist:null,allStyles:null};return t.querySelectorAll(this.SELECTORS.timeContainer).forEach(t=>{try{const a=t.querySelector(this.SELECTORS.timeLabel),i=t.querySelector(this.SELECTORS.timeValue);if(!a||!i)return;const s=this.cleanText(a.textContent||"").toLowerCase(),l=this.cleanText(i.textContent||"");if(!s||!l)return;const n=this.parseTimeString(l);s.includes("main story")||s.includes("main")?e.mainStory=n:s.includes("main + extra")||s.includes("main+extra")?e.mainExtra=n:s.includes("completionist")||s.includes("100%")?e.completionist=n:(s.includes("all styles")||s.includes("average"))&&(e.allStyles=n)}catch(t){console.warn("[HLTB Scraper] Error parsing time container:",t)}}),e}parseTimeString(t){if(!t||"--"===t||"-"===t||"n/a"===t.toLowerCase())return null;const e=t.toLowerCase().trim().replace(/hours?/g,"").replace(/hrs?/g,"").replace(/h/g,"").replace(/mins?/g,"").replace(/m/g,"").trim();if(!e)return null;try{let t=e.replace(/½/g,".5").replace(/¼/g,".25").replace(/¾/g,".75").replace(/⅓/g,".33").replace(/⅔/g,".67");const a=t.match(/(\d+(?:\.\d+)?)\s*[-–—]\s*(\d+(?:\.\d+)?)/);if(a){const t=parseFloat(a[1]),e=parseFloat(a[2]);if(!isNaN(t)&&!isNaN(e))return Math.round((t+e)/2)}const i=t.match(/(\d+(?:\.\d+)?)/);if(i){const t=parseFloat(i[1]);if(!isNaN(t)&&t>0)return Math.round(t)}return null}catch(e){return console.warn("[HLTB Scraper] Error parsing time string:",t,e),null}}extractGameIdFromUrl(t){try{const e=t.match(/[?&]id=(\d+)/);return e?e[1]:null}catch(e){return console.warn("[HLTB Scraper] Error extracting game ID from URL:",t,e),null}}normalizeUrl(t){return t?t.startsWith("//")?`https:${t}`:t.startsWith("/")?`${this.BASE_URL}${t}`:t:""}cleanText(t){return t?t.replace(/\s+/g," ").replace(/\n+/g," ").trim().substring(0,200):""}async findBestMatch(t,e){if(!e||0===e.length)return null;const{titleMatcher:a}=await s.e(147).then(s.bind(s,147)),i=e.map(t=>({gameId:t.id||"",gameName:t.name,mainStory:t.mainStory,mainExtra:t.mainExtra,completionist:t.completionist,allStyles:t.allStyles})),l=await a.findBestMatch(t,i);return l&&l.match?l.skip?(console.log(`[HLTB Scraper] Skipping "${t}": ${l.reason}`),null):(console.log(`[HLTB Scraper] Matched "${t}" -> "${l.match.gameName}" (${(100*l.confidence).toFixed(1)}% via ${l.method})`),e.find(t=>t.name===l.match.gameName)||null):(console.log(`[HLTB Scraper] No match found for "${t}"`),null)}calculateSimilarity(t,e){if(t===e)return 1;const a=t.length>e.length?t:e,i=t.length>e.length?e:t;if(0===a.length)return 0;const s=this.levenshteinDistance(a,i);return(a.length-s)/a.length}levenshteinDistance(t,e){const a=[];for(let t=0;t<=e.length;t++)a[t]=[t];for(let e=0;e<=t.length;e++)a[0][e]=e;for(let i=1;i<=e.length;i++)for(let s=1;s<=t.length;s++)e.charAt(i-1)===t.charAt(s-1)?a[i][s]=a[i-1][s-1]:a[i][s]=Math.min(a[i-1][s-1]+1,a[i][s-1]+1,a[i-1][s]+1);return a[e.length][t.length]}validateGameData(t){return!!(t&&"string"==typeof t.name&&t.name.length>0&&t.name.length<=200)}async getScraperStatus(){const t=Date.now();try{const e=await fetch(`${this.BASE_URL}/search_results?search=portal`,{method:"HEAD",headers:{"User-Agent":this.USER_AGENT}}),a=Date.now()-t;return{isHealthy:e.ok,lastCheck:Date.now(),responseTime:a,error:e.ok?null:`HTTP ${e.status}`}}catch(t){return{isHealthy:!1,lastCheck:Date.now(),responseTime:null,error:t instanceof Error?t.message:"Unknown error"}}}},m=JSON.parse('{"ag":[{"title":"Portal","aliases":["portal 1"],"data":{"mainStory":3,"mainExtra":4,"completionist":5,"allStyles":4},"confidence":"high","lastUpdated":"2024-01"},{"title":"Portal 2","aliases":["portal two","portal ii"],"data":{"mainStory":8,"mainExtra":10,"completionist":14,"allStyles":9},"confidence":"high","lastUpdated":"2024-01"},{"title":"Half-Life","aliases":["halflife","half life"],"data":{"mainStory":12,"mainExtra":13,"completionist":15,"allStyles":12},"confidence":"high","lastUpdated":"2024-01"},{"title":"Half-Life 2","aliases":["halflife 2","half life 2","hl2"],"data":{"mainStory":13,"mainExtra":15,"completionist":18,"allStyles":13},"confidence":"high","lastUpdated":"2024-01"},{"title":"Half-Life: Alyx","aliases":["half life alyx","hl alyx","alyx"],"data":{"mainStory":12,"mainExtra":13,"completionist":18,"allStyles":12},"confidence":"high","lastUpdated":"2024-01"},{"title":"Team Fortress 2","aliases":["tf2","team fortress two"],"data":{"mainStory":null,"mainExtra":null,"completionist":null,"allStyles":null},"confidence":"high"},{"title":"Counter-Strike 2","aliases":["cs2","cs 2","counterstrike 2"],"data":{"mainStory":null,"mainExtra":null,"completionist":null,"allStyles":null},"confidence":"high"},{"title":"Counter-Strike: Global Offensive","aliases":["csgo","cs go","cs:go"],"data":{"mainStory":null,"mainExtra":null,"completionist":null,"allStyles":null},"confidence":"high"},{"title":"Dota 2","aliases":["dota two"],"data":{"mainStory":null,"mainExtra":null,"completionist":null,"allStyles":null},"confidence":"high"},{"title":"Hades","aliases":["hades 1"],"data":{"mainStory":22,"mainExtra":45,"completionist":95,"allStyles":55},"confidence":"high","lastUpdated":"2024-01"},{"title":"Hades II","aliases":["hades 2","hades two"],"data":{"mainStory":15,"mainExtra":25,"completionist":50,"allStyles":30},"confidence":"medium","lastUpdated":"2024-09"},{"title":"Hollow Knight","aliases":[],"data":{"mainStory":27,"mainExtra":41,"completionist":65,"allStyles":42},"confidence":"high","lastUpdated":"2025-10"},{"title":"Celeste","aliases":[],"data":{"mainStory":8,"mainExtra":12,"completionist":37,"allStyles":28},"confidence":"high","lastUpdated":"2024-01"},{"title":"Stardew Valley","aliases":[],"data":{"mainStory":53,"mainExtra":95,"completionist":156,"allStyles":96},"confidence":"high","lastUpdated":"2024-01"},{"title":"Terraria","aliases":[],"data":{"mainStory":50,"mainExtra":104,"completionist":215,"allStyles":115},"confidence":"high","lastUpdated":"2024-01"},{"title":"Elden Ring","aliases":[],"data":{"mainStory":60,"mainExtra":100,"completionist":130,"allStyles":96},"confidence":"high","lastUpdated":"2024-01"},{"title":"The Witcher 3: Wild Hunt","aliases":["witcher 3","the witcher three"],"data":{"mainStory":50,"mainExtra":100,"completionist":170,"allStyles":101},"confidence":"high","lastUpdated":"2024-01"},{"title":"Red Dead Redemption 2","aliases":["rdr2","red dead 2"],"data":{"mainStory":50,"mainExtra":80,"completionist":180,"allStyles":80},"confidence":"high","lastUpdated":"2024-01"},{"title":"Grand Theft Auto V","aliases":["gta 5","gta v","gtav"],"data":{"mainStory":32,"mainExtra":48,"completionist":83,"allStyles":52},"confidence":"high","lastUpdated":"2024-01"},{"title":"Cyberpunk 2077","aliases":["cyberpunk","cp2077"],"data":{"mainStory":25,"mainExtra":60,"completionist":105,"allStyles":61},"confidence":"high","lastUpdated":"2024-01"},{"title":"Baldur\'s Gate 3","aliases":["bg3","baldurs gate 3"],"data":{"mainStory":75,"mainExtra":100,"completionist":200,"allStyles":107},"confidence":"high","lastUpdated":"2024-01"},{"title":"Dark Souls","aliases":["dark souls 1","ds1"],"data":{"mainStory":42,"mainExtra":60,"completionist":105,"allStyles":66},"confidence":"high","lastUpdated":"2024-01"},{"title":"Dark Souls II","aliases":["dark souls 2","ds2"],"data":{"mainStory":44,"mainExtra":70,"completionist":120,"allStyles":78},"confidence":"high","lastUpdated":"2024-01"},{"title":"Dark Souls III","aliases":["dark souls 3","ds3"],"data":{"mainStory":32,"mainExtra":48,"completionist":100,"allStyles":59},"confidence":"high","lastUpdated":"2024-01"},{"title":"Sekiro: Shadows Die Twice","aliases":["sekiro"],"data":{"mainStory":30,"mainExtra":40,"completionist":70,"allStyles":41},"confidence":"high","lastUpdated":"2024-01"},{"title":"Civilization VI","aliases":["civ 6","civ vi","civilization 6"],"data":{"mainStory":22,"mainExtra":40,"completionist":220,"allStyles":81},"confidence":"high","lastUpdated":"2024-01"},{"title":"Total War: WARHAMMER III","aliases":["total warhammer 3","tww3"],"data":{"mainStory":32,"mainExtra":125,"completionist":280,"allStyles":180},"confidence":"medium","lastUpdated":"2024-01"},{"title":"The Binding of Isaac: Rebirth","aliases":["binding of isaac rebirth","tboi rebirth"],"data":{"mainStory":13,"mainExtra":50,"completionist":270,"allStyles":140},"confidence":"high","lastUpdated":"2024-01"},{"title":"Risk of Rain 2","aliases":["ror2"],"data":{"mainStory":10,"mainExtra":30,"completionist":120,"allStyles":59},"confidence":"high","lastUpdated":"2024-01"},{"title":"Dead Cells","aliases":[],"data":{"mainStory":14,"mainExtra":30,"completionist":83,"allStyles":46},"confidence":"high","lastUpdated":"2024-01"},{"title":"Pumpkin Jack","aliases":[],"data":{"mainStory":5,"mainExtra":6,"completionist":7,"allStyles":5},"confidence":"high","lastUpdated":"2025-10"},{"title":"The Elder Scrolls V: Skyrim","aliases":["skyrim","skyrim special edition"],"data":{"mainStory":26,"mainExtra":108,"completionist":232,"allStyles":110},"confidence":"high","lastUpdated":"2025-10"},{"title":"Fallout 4","aliases":[],"data":{"mainStory":27,"mainExtra":77,"completionist":156,"allStyles":84},"confidence":"high","lastUpdated":"2025-10"},{"title":"Minecraft","aliases":[],"data":{"mainStory":null,"mainExtra":null,"completionist":null,"allStyles":327},"confidence":"medium","lastUpdated":"2025-10"},{"title":"Rust","aliases":[],"data":{"mainStory":null,"mainExtra":null,"completionist":null,"allStyles":null},"confidence":"high"},{"title":"ARK: Survival Evolved","aliases":["ark"],"data":{"mainStory":60,"mainExtra":145,"completionist":630,"allStyles":273},"confidence":"high","lastUpdated":"2025-10"},{"title":"Rocket League","aliases":[],"data":{"mainStory":null,"mainExtra":null,"completionist":null,"allStyles":null},"confidence":"high"},{"title":"Apex Legends","aliases":[],"data":{"mainStory":null,"mainExtra":null,"completionist":null,"allStyles":null},"confidence":"high"},{"title":"PUBG: BATTLEGROUNDS","aliases":["pubg","playerunknown\'s battlegrounds"],"data":{"mainStory":null,"mainExtra":null,"completionist":null,"allStyles":null},"confidence":"high"},{"title":"Warframe","aliases":[],"data":{"mainStory":null,"mainExtra":null,"completionist":null,"allStyles":181},"confidence":"medium","lastUpdated":"2025-10"},{"title":"Destiny 2","aliases":[],"data":{"mainStory":12,"mainExtra":84,"completionist":185,"allStyles":103},"confidence":"high","lastUpdated":"2025-10"},{"title":"Resident Evil Village","aliases":["re village","resident evil 8"],"data":{"mainStory":10,"mainExtra":14,"completionist":30,"allStyles":15},"confidence":"high","lastUpdated":"2025-10"},{"title":"Resident Evil 4","aliases":["re4"],"data":{"mainStory":16,"mainExtra":18,"completionist":39,"allStyles":18},"confidence":"high","lastUpdated":"2025-10"},{"title":"God of War","aliases":[],"data":{"mainStory":21,"mainExtra":32,"completionist":51,"allStyles":32},"confidence":"high","lastUpdated":"2025-10"},{"title":"Horizon Zero Dawn","aliases":[],"data":{"mainStory":29,"mainExtra":47,"completionist":62,"allStyles":47},"confidence":"high","lastUpdated":"2025-10"},{"title":"Spider-Man Remastered","aliases":["spider-man","spiderman"],"data":{"mainStory":17,"mainExtra":28,"completionist":35,"allStyles":28},"confidence":"high","lastUpdated":"2025-10"},{"title":"Death Stranding","aliases":[],"data":{"mainStory":41,"mainExtra":57,"completionist":113,"allStyles":60},"confidence":"high","lastUpdated":"2025-10"},{"title":"Control","aliases":[],"data":{"mainStory":12,"mainExtra":18,"completionist":27,"allStyles":18},"confidence":"high","lastUpdated":"2025-10"},{"title":"Dishonored","aliases":[],"data":{"mainStory":12,"mainExtra":17,"completionist":32,"allStyles":18},"confidence":"high","lastUpdated":"2025-10"},{"title":"Dishonored 2","aliases":[],"data":{"mainStory":12,"mainExtra":18,"completionist":35,"allStyles":18},"confidence":"high","lastUpdated":"2025-10"},{"title":"Prey","aliases":["prey 2017"],"data":{"mainStory":16,"mainExtra":24,"completionist":38,"allStyles":24},"confidence":"high","lastUpdated":"2025-10"},{"title":"Metro Exodus","aliases":[],"data":{"mainStory":15,"mainExtra":20,"completionist":32,"allStyles":20},"confidence":"high","lastUpdated":"2025-10"},{"title":"BioShock","aliases":["bioshock 1"],"data":{"mainStory":12,"mainExtra":15,"completionist":24,"allStyles":14},"confidence":"high","lastUpdated":"2025-10"},{"title":"BioShock Infinite","aliases":[],"data":{"mainStory":12,"mainExtra":15,"completionist":28,"allStyles":15},"confidence":"high","lastUpdated":"2025-10"},{"title":"The Last of Us Part I","aliases":["the last of us","tlou"],"data":{"mainStory":15,"mainExtra":18,"completionist":22,"allStyles":17},"confidence":"high","lastUpdated":"2025-10"},{"title":"Uncharted: Legacy of Thieves Collection","aliases":["uncharted 4"],"data":{"mainStory":15,"mainExtra":21,"completionist":28,"allStyles":20},"confidence":"high","lastUpdated":"2025-10"},{"title":"It Takes Two","aliases":[],"data":{"mainStory":11,"mainExtra":14,"completionist":15,"allStyles":12},"confidence":"high","lastUpdated":"2025-10"},{"title":"A Way Out","aliases":[],"data":{"mainStory":6,"mainExtra":7,"completionist":12,"allStyles":7},"confidence":"high","lastUpdated":"2025-10"},{"title":"Hitman 3","aliases":["hitman world of assassination"],"data":{"mainStory":8,"mainExtra":20,"completionist":78,"allStyles":37},"confidence":"high","lastUpdated":"2025-10"},{"title":"Doom Eternal","aliases":[],"data":{"mainStory":14,"mainExtra":22,"completionist":42,"allStyles":23},"confidence":"high","lastUpdated":"2025-10"},{"title":"Doom (2016)","aliases":["doom 2016","doom 4"],"data":{"mainStory":11,"mainExtra":16,"completionist":27,"allStyles":16},"confidence":"high","lastUpdated":"2025-10"},{"title":"Wolfenstein: The New Order","aliases":[],"data":{"mainStory":11,"mainExtra":14,"completionist":21,"allStyles":14},"confidence":"high","lastUpdated":"2025-10"},{"title":"Titanfall 2","aliases":[],"data":{"mainStory":6,"mainExtra":9,"completionist":15,"allStyles":9},"confidence":"high","lastUpdated":"2025-10"},{"title":"Mass Effect Legendary Edition","aliases":["mass effect trilogy"],"data":{"mainStory":63,"mainExtra":97,"completionist":139,"allStyles":97},"confidence":"high","lastUpdated":"2025-10"},{"title":"Dragon Age: Inquisition","aliases":["dai"],"data":{"mainStory":50,"mainExtra":91,"completionist":132,"allStyles":90},"confidence":"high","lastUpdated":"2025-10"},{"title":"Divinity: Original Sin 2","aliases":["dos2"],"data":{"mainStory":60,"mainExtra":93,"completionist":141,"allStyles":93},"confidence":"high","lastUpdated":"2025-10"},{"title":"Pillars of Eternity II: Deadfire","aliases":["poe2"],"data":{"mainStory":42,"mainExtra":73,"completionist":131,"allStyles":80},"confidence":"high","lastUpdated":"2025-10"},{"title":"Disco Elysium","aliases":[],"data":{"mainStory":21,"mainExtra":27,"completionist":32,"allStyles":26},"confidence":"high","lastUpdated":"2025-10"},{"title":"Undertale","aliases":[],"data":{"mainStory":7,"mainExtra":10,"completionist":22,"allStyles":11},"confidence":"high","lastUpdated":"2025-10"},{"title":"Deltarune","aliases":[],"data":{"mainStory":6,"mainExtra":9,"completionist":16,"allStyles":9},"confidence":"high","lastUpdated":"2025-10"},{"title":"Cuphead","aliases":[],"data":{"mainStory":10,"mainExtra":15,"completionist":23,"allStyles":15},"confidence":"high","lastUpdated":"2025-10"},{"title":"Ori and the Blind Forest","aliases":[],"data":{"mainStory":8,"mainExtra":10,"completionist":12,"allStyles":9},"confidence":"high","lastUpdated":"2025-10"},{"title":"Ori and the Will of the Wisps","aliases":[],"data":{"mainStory":12,"mainExtra":16,"completionist":25,"allStyles":16},"confidence":"high","lastUpdated":"2025-10"},{"title":"Factorio","aliases":[],"data":{"mainStory":32,"mainExtra":91,"completionist":163,"allStyles":95},"confidence":"high","lastUpdated":"2025-10"},{"title":"Rimworld","aliases":[],"data":{"mainStory":null,"mainExtra":null,"completionist":null,"allStyles":147},"confidence":"medium","lastUpdated":"2025-10"},{"title":"Satisfactory","aliases":[],"data":{"mainStory":55,"mainExtra":117,"completionist":282,"allStyles":126},"confidence":"high","lastUpdated":"2025-10"},{"title":"Subnautica","aliases":[],"data":{"mainStory":29,"mainExtra":43,"completionist":56,"allStyles":42},"confidence":"high","lastUpdated":"2025-10"},{"title":"The Forest","aliases":[],"data":{"mainStory":13,"mainExtra":18,"completionist":40,"allStyles":21},"confidence":"high","lastUpdated":"2025-10"},{"title":"Valheim","aliases":[],"data":{"mainStory":75,"mainExtra":139,"completionist":177,"allStyles":138},"confidence":"high","lastUpdated":"2025-10"},{"title":"No Man\'s Sky","aliases":[],"data":{"mainStory":31,"mainExtra":91,"completionist":139,"allStyles":100},"confidence":"high","lastUpdated":"2025-10"},{"title":"Among Us","aliases":[],"data":{"mainStory":null,"mainExtra":null,"completionist":null,"allStyles":null},"confidence":"high"},{"title":"Fall Guys","aliases":[],"data":{"mainStory":null,"mainExtra":null,"completionist":null,"allStyles":null},"confidence":"high"},{"title":"Vampire Survivors","aliases":[],"data":{"mainStory":4,"mainExtra":14,"completionist":54,"allStyles":33},"confidence":"high","lastUpdated":"2025-10"},{"title":"Enter the Gungeon","aliases":[],"data":{"mainStory":16,"mainExtra":36,"completionist":86,"allStyles":48},"confidence":"high","lastUpdated":"2025-10"},{"title":"Slay the Spire","aliases":[],"data":{"mainStory":12,"mainExtra":42,"completionist":113,"allStyles":64},"confidence":"high","lastUpdated":"2025-10"},{"title":"Darkest Dungeon","aliases":[],"data":{"mainStory":55,"mainExtra":80,"completionist":105,"allStyles":77},"confidence":"high","lastUpdated":"2025-10"},{"title":"Monster Hunter: World","aliases":["mhw"],"data":{"mainStory":48,"mainExtra":111,"completionist":403,"allStyles":174},"confidence":"high","lastUpdated":"2025-10"},{"title":"Monster Hunter Rise","aliases":["mhr"],"data":{"mainStory":20,"mainExtra":48,"completionist":143,"allStyles":83},"confidence":"high","lastUpdated":"2025-10"},{"title":"Persona 5 Royal","aliases":["p5r"],"data":{"mainStory":101,"mainExtra":123,"completionist":143,"allStyles":120},"confidence":"high","lastUpdated":"2025-10"},{"title":"NieR: Automata","aliases":["nier automata"],"data":{"mainStory":21,"mainExtra":39,"completionist":62,"allStyles":40},"confidence":"high","lastUpdated":"2025-10"},{"title":"Yakuza 0","aliases":[],"data":{"mainStory":31,"mainExtra":62,"completionist":141,"allStyles":71},"confidence":"high","lastUpdated":"2025-10"},{"title":"Final Fantasy XIV Online","aliases":["ffxiv","ff14"],"data":{"mainStory":166,"mainExtra":367,"completionist":null,"allStyles":1216},"confidence":"medium","lastUpdated":"2025-10"},{"title":"The Talos Principle","aliases":[],"data":{"mainStory":12,"mainExtra":20,"completionist":29,"allStyles":19},"confidence":"high","lastUpdated":"2025-10"},{"title":"The Witness","aliases":[],"data":{"mainStory":10,"mainExtra":19,"completionist":30,"allStyles":20},"confidence":"high","lastUpdated":"2025-10"},{"title":"Braid","aliases":[],"data":{"mainStory":4,"mainExtra":6,"completionist":10,"allStyles":6},"confidence":"high","lastUpdated":"2025-10"},{"title":"Limbo","aliases":[],"data":{"mainStory":3,"mainExtra":4,"completionist":9,"allStyles":5},"confidence":"high","lastUpdated":"2025-10"},{"title":"Inside","aliases":[],"data":{"mainStory":3,"mainExtra":5,"completionist":11,"allStyles":6},"confidence":"high","lastUpdated":"2025-10"},{"title":"Little Nightmares","aliases":[],"data":{"mainStory":4,"mainExtra":5,"completionist":12,"allStyles":6},"confidence":"high","lastUpdated":"2025-10"},{"title":"Little Nightmares II","aliases":["little nightmares 2"],"data":{"mainStory":5,"mainExtra":7,"completionist":12,"allStyles":7},"confidence":"high","lastUpdated":"2025-10"}]}'),d=new class{constructor(){this.COMMUNITY_DB_URL="https://raw.githubusercontent.com/username/hltb-db/main/games.json",this.localDatabase=new Map,this.aliasMap=new Map,this.initializeLocalDatabase(),this.loadCommunityDatabase()}initializeLocalDatabase(){const t=m.ag;for(const e of t){const t=this.normalizeTitle(e.title);if(this.localDatabase.set(t,e),e.aliases)for(const a of e.aliases)this.aliasMap.set(this.normalizeTitle(a),t)}console.log(`[HLTB Fallback] Initialized with ${this.localDatabase.size} games`)}async loadCommunityDatabase(){try{const t=await fetch(this.COMMUNITY_DB_URL,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(5e3)});if(t.ok){const e=await t.json();this.populateCommunityData(e),console.log("[HLTB Fallback] Community database loaded")}}catch(t){console.log("[HLTB Fallback] Community database not available, using local data only")}}populateCommunityData(t){if(!Array.isArray(t))return;let e=0;for(const a of t){if(!a.title||!a.data)continue;const t=this.normalizeTitle(a.title),i=this.localDatabase.get(t);i&&"high"===i.confidence||(this.localDatabase.set(t,{title:a.title,aliases:a.aliases||[],data:a.data,confidence:"medium",lastUpdated:a.lastUpdated}),e++)}console.log(`[HLTB Fallback] Added ${e} games from community database`)}async searchFallback(t){const e=this.normalizeTitle(t);if(this.localDatabase.has(e))return console.log(`[HLTB Fallback] Direct match found for: ${t}`),this.localDatabase.get(e).data;if(this.aliasMap.has(e)){const a=this.aliasMap.get(e);return console.log(`[HLTB Fallback] Alias match found for: ${t}`),this.localDatabase.get(a).data}const a=this.findFuzzyMatch(e);if(a)return console.log(`[HLTB Fallback] Fuzzy match found for: ${t}`),a;const i=this.findPartialMatch(e);return i?(console.log(`[HLTB Fallback] Partial match found for: ${t}`),i):(console.log(`[HLTB Fallback] No match found for: ${t}`),null)}findFuzzyMatch(t){const e=t.split(/\s+/);let a=null,i=0;for(const[t,s]of this.localDatabase.entries()){const l=t.split(/\s+/);let n=0;for(const t of e)l.some(e=>e.includes(t)||t.includes(e))&&n++;const r=n/Math.max(e.length,l.length);r>i&&r>=.5&&(i=r,a=s)}return a?a.data:null}findPartialMatch(t){for(const[e,a]of this.localDatabase.entries())if((e.includes(t)||t.includes(e))&&(!t.includes(e)||e.length>.5*t.length))return a.data;return null}normalizeTitle(t){return t.toLowerCase().replace(/[^a-z0-9\s]/g,"").replace(/\s+/g," ").trim()}getAvailableGames(){return Array.from(this.localDatabase.values()).map(t=>t.title)}getStats(){const t=Array.from(this.localDatabase.values()).filter(t=>"high"===t.confidence).length,e=Array.from(this.localDatabase.values()).filter(t=>"medium"===t.confidence).length,a=Array.from(this.localDatabase.values()).filter(t=>"low"===t.confidence).length;return{totalGames:this.localDatabase.size,totalAliases:this.aliasMap.size,highConfidence:t,mediumConfidence:e,lowConfidence:a}}};class u{constructor(){this.CACHE_KEY="hltb_cache",this.cache=new Map,this.cacheDuration=6048e5,this.loadCache()}async loadCache(){const t=await chrome.storage.local.get(this.CACHE_KEY);t[this.CACHE_KEY]&&(this.cache=new Map(Object.entries(t[this.CACHE_KEY])),this.cleanExpired())}async saveCache(){await chrome.storage.local.set({[this.CACHE_KEY]:Object.fromEntries(this.cache)})}async get(t){const e=this.cache.get(t);return e?Date.now()-e.timestamp>this.cacheDuration?(this.cache.delete(t),await this.saveCache(),null):(e.hits++,await this.saveCache(),e.data):null}async set(t,e){this.cache.set(t,{data:e,timestamp:Date.now(),hits:0}),this.cache.size>1e3&&this.evictLRU(),await this.saveCache()}cleanExpired(){const t=Date.now();for(const[e,a]of this.cache.entries())t-a.timestamp>this.cacheDuration&&this.cache.delete(e)}evictLRU(){let t="",e=1/0;for(const[a,i]of this.cache.entries()){const s=i.hits+(Date.now()-i.timestamp)/1e6;s<e&&(e=s,t=a)}t&&this.cache.delete(t)}async getStats(){const t=Array.from(this.cache.values());return 0===t.length?{size:0,hits:0,oldestEntry:null,totalSize:0}:{size:this.cache.size,hits:t.reduce((t,e)=>t+e.hits,0),oldestEntry:Math.min(...t.map(t=>t.timestamp)),totalSize:JSON.stringify(Object.fromEntries(this.cache)).length}}async clear(){this.cache.clear(),await chrome.storage.local.remove(this.CACHE_KEY)}}class p{constructor(t,e){this.maxTokens=t,this.windowMs=e,this.tokens=t,this.lastRefill=Date.now()}async wait(){if(this.refill(),this.tokens>0)return void this.tokens--;const t=this.windowMs-(Date.now()-this.lastRefill);await new Promise(e=>setTimeout(e,t)),this.refill(),this.tokens--}refill(){const t=Date.now();t-this.lastRefill>=this.windowMs&&(this.tokens=this.maxTokens,this.lastRefill=t)}}class g{constructor(){this.queue=[],this.processing=!1,this.rateLimiter=new p(10,6e4)}async enqueue(t){return new Promise((e,a)=>{this.queue.push(async()=>{try{await this.rateLimiter.wait();const a=await t();e(a)}catch(t){a(t)}}),this.process()})}async process(){if(!this.processing&&0!==this.queue.length){for(this.processing=!0;this.queue.length>0;){const t=this.queue.shift();t&&await t()}this.processing=!1}}async flush(){return Promise.all(this.queue.map(t=>t()))}}const y=new class{constructor(){this.stats={apiAttempts:0,apiSuccesses:0,scraperAttempts:0,scraperSuccesses:0,fallbackAttempts:0,fallbackSuccesses:0,cacheHits:0,totalRequests:0,averageRetrievalTime:0},this.totalRetrievalTime=0,this.apiClient=new o({maxRetries:3,baseDelay:1e3,timeout:1e4}),this.cacheService=new u,this.queueService=new g}async getGameData(t,e,a={}){const i=Date.now();this.stats.totalRequests++,console.log(`[HLTB Integrated] Searching for: ${t}`);try{if(!a.skipCache){const a=await this.tryCache(t,e);if(a)return this.updateRetrievalTime(Date.now()-i),a}return await this.queueService.enqueue(async()=>{let s=null;return!a.skipApi&&(s=await this.tryAPI(t,a),s)||!a.skipScraping&&(s=await this.tryScraping(t,a),s)||!a.skipFallback&&(s=await this.tryFallback(t),s)?(await this.cacheResult(t,e,s),this.updateRetrievalTime(Date.now()-i),s):(console.log(`[HLTB Integrated] No data found for: ${t}`),this.updateRetrievalTime(Date.now()-i),null)})}catch(t){return console.error("[HLTB Integrated] Fatal error:",t),this.updateRetrievalTime(Date.now()-i),null}}async tryCache(t,e){const a=(e||t).replace(/[^a-zA-Z0-9_-]/g,"").substring(0,50),i=await this.cacheService.get(a);return i?(console.log("[HLTB Integrated] Cache hit for:",t),this.stats.cacheHits++,i.source||(i.source="cache"),i.confidence||(i.confidence="medium"),i.retrievalTime||(i.retrievalTime=0),i):null}async tryAPI(t,e){console.log("[HLTB Integrated] Trying API for:",t),this.stats.apiAttempts++;try{const e=await this.apiClient.getGameData(t);if(e)return console.log("[HLTB Integrated] API success for:",t),this.stats.apiSuccesses++,{...e,source:"api",confidence:"high",retrievalTime:Date.now()}}catch(t){t instanceof l?console.warn("[HLTB Integrated] API rate limited, skipping API for future requests"):t instanceof n?console.warn("[HLTB Integrated] API network error:",t.message):console.error("[HLTB Integrated] API error:",t)}return null}async tryScraping(t,e){console.log("[HLTB Integrated] Trying scraper for:",t),this.stats.scraperAttempts++;try{const e=await h.scrapeGameData(t);if(e&&e.games.length>0){const a=await h.findBestMatch(t,e.games);if(a)return console.log("[HLTB Integrated] Scraper success for:",t),this.stats.scraperSuccesses++,{mainStory:a.mainStory,mainExtra:a.mainExtra,completionist:a.completionist,allStyles:a.allStyles,source:"scraper",confidence:"medium",retrievalTime:Date.now()}}}catch(t){console.error("[HLTB Integrated] Scraper error:",t)}return null}async tryFallback(t){console.log("[HLTB Integrated] Trying fallback for:",t),this.stats.fallbackAttempts++;try{const e=await d.searchFallback(t);if(e)return console.log("[HLTB Integrated] Fallback success for:",t),this.stats.fallbackSuccesses++,{...e,source:"fallback",confidence:"low",retrievalTime:Date.now()}}catch(t){console.error("[HLTB Integrated] Fallback error:",t)}return null}async cacheResult(t,e,a){const i=(e||t).replace(/[^a-zA-Z0-9_-]/g,"").substring(0,50);try{await this.cacheService.set(i,a),console.log(`[HLTB Integrated] Cached result for: ${t}`)}catch(t){console.error("[HLTB Integrated] Cache write error:",t)}}updateRetrievalTime(t){this.totalRetrievalTime+=t,this.stats.averageRetrievalTime=Math.round(this.totalRetrievalTime/this.stats.totalRequests)}async batchFetch(t,e={}){const a=new Map;for(let i=0;i<t.length;i+=5){const s=t.slice(i,i+5).map(t=>this.getGameData(t.title,t.appId,e).then(e=>({key:t.appId||t.title,data:e}))),l=await Promise.allSettled(s);for(const t of l)"fulfilled"===t.status?a.set(t.value.key,t.value.data):console.error("[HLTB Integrated] Batch fetch error:",t.reason);i+5<t.length&&await new Promise(t=>setTimeout(t,500))}return a}getStats(){return{...this.stats}}resetStats(){this.stats={apiAttempts:0,apiSuccesses:0,scraperAttempts:0,scraperSuccesses:0,fallbackAttempts:0,fallbackSuccesses:0,cacheHits:0,totalRequests:0,averageRetrievalTime:0},this.totalRetrievalTime=0}async clearCache(){const t=await this.cacheService.clear();return console.log(`[HLTB Integrated] Cleared ${t} cache entries`),t}async getDiagnostics(){const[t,e,a]=await Promise.all([this.cacheService.getStats(),d.getStats(),h.getScraperStatus()]);return{service:{stats:this.getStats(),successRates:{api:this.stats.apiAttempts>0?(this.stats.apiSuccesses/this.stats.apiAttempts*100).toFixed(1)+"%":"N/A",scraper:this.stats.scraperAttempts>0?(this.stats.scraperSuccesses/this.stats.scraperAttempts*100).toFixed(1)+"%":"N/A",fallback:this.stats.fallbackAttempts>0?(this.stats.fallbackSuccesses/this.stats.fallbackAttempts*100).toFixed(1)+"%":"N/A",cacheHitRate:this.stats.totalRequests>0?(this.stats.cacheHits/this.stats.totalRequests*100).toFixed(1)+"%":"N/A"}},cache:t,fallback:e,scraper:a}}async healthCheck(){const t=[];this.stats.apiAttempts>10&&0===this.stats.apiSuccesses&&t.push("API is not responding"),this.stats.scraperAttempts>10&&0===this.stats.scraperSuccesses&&t.push("Scraper is not working"),this.stats.averageRetrievalTime>5e3&&t.push(`Slow average retrieval time: ${this.stats.averageRetrievalTime}ms`);const e=await this.cacheService.getStats();return e.size>1e3&&t.push(`Cache is getting large: ${e.size} entries`),{healthy:0===t.length,issues:t}}},f=new class{constructor(t){this.hltbService=t}async handle(t,e){switch(t.action){case"fetchHLTB":return this.handleFetchHLTB(t);case"clearCache":return this.handleClearCache();case"getCacheStats":return this.handleGetCacheStats();case"batchFetch":return this.handleBatchFetch(t);case"getSettings":return this.handleGetSettings();case"getDiagnostics":return this.handleGetDiagnostics();case"getStats":return this.handleGetStats();case"healthCheck":return this.handleHealthCheck();default:throw new Error(`Unknown action: ${t.action}`)}}async handleFetchHLTB(t){const{gameTitle:e,appId:a}=t;if(!e)return{success:!1,error:"Game title is required"};if(a&&("string"!=typeof a||!/^\d+$/.test(a)))return{success:!1,error:"Invalid app ID"};if("string"!=typeof e||e.length>200)return{success:!1,error:"Invalid game title"};try{return{success:!0,data:await this.hltbService.getGameData(e,a)}}catch(t){return console.error("[HLTB] Fetch error:",t),{success:!1,error:t.message}}}async handleClearCache(){return{success:!0,message:`Cache cleared (${await this.hltbService.clearCache()} entries)`}}async handleGetCacheStats(){return{success:!0,data:(await this.hltbService.getDiagnostics()).cache}}async handleGetSettings(){try{const t=await chrome.storage.local.get(["enabled","cacheEnabled","theme","cacheDurationHours"]);return{success:!0,settings:{enabled:!1!==t.enabled,cacheEnabled:!1!==t.cacheEnabled,theme:t.theme||"auto",cacheDurationHours:t.cacheDurationHours||168}}}catch(t){return console.error("[HLTB] Error getting settings:",t),{success:!1,error:t.message}}}async handleBatchFetch(t){const{games:e}=t;return Array.isArray(e)?{success:!0,data:await this.hltbService.batchFetch(e)}:{success:!1,error:"Games array is required"}}async handleGetDiagnostics(){try{return{success:!0,data:await this.hltbService.getDiagnostics()}}catch(t){return console.error("[HLTB] Error getting diagnostics:",t),{success:!1,error:t.message}}}async handleGetStats(){try{return{success:!0,data:this.hltbService.getStats()}}catch(t){return console.error("[HLTB] Error getting stats:",t),{success:!1,error:t.message}}}async handleHealthCheck(){try{return{success:!0,data:await this.hltbService.healthCheck()}}catch(t){return console.error("[HLTB] Error checking health:",t),{success:!1,error:t.message}}}}(y);chrome.runtime.onInstalled.addListener(async t=>{if(console.log("[HLTB] Extension installed:",t.reason),"install"===t.reason)await chrome.storage.local.set({enabled:!0,cacheEnabled:!0,cacheDurationHours:168,rateLimit:{maxRequests:10,windowMs:6e4}});else if("update"===t.reason){const e=t.previousVersion;console.log("[HLTB] Updated from version:",e)}}),chrome.runtime.onMessage.addListener((t,e,a)=>(console.log("[HLTB] Message received:",t.action),f.handle(t,e).then(a).catch(t=>{console.error("[HLTB] Message handler error:",t),a({success:!1,error:t.message})}),!0)),chrome.alarms.create("keep-alive",{periodInMinutes:.25}),chrome.alarms.onAlarm.addListener(t=>{"keep-alive"===t.name&&chrome.runtime.getPlatformInfo(()=>{})}),chrome.runtime.onSuspend.addListener(()=>{console.log("[HLTB] Service worker suspending...")})})();